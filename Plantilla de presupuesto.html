<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presupuesto Comercial Editable A4 - COMPLETO</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // ✅ TU CONFIGURACIÓN DE FIREBASE
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyBJgrjdpYpxVmbfNAnKdKc-shamZErc-xg",
            authDomain: "plantilla-de-presupuesto.firebaseapp.com",
            projectId: "plantilla-de-presupuesto",
            storageBucket: "plantilla-de-presupuesto.appspot.com", // ✅ CAMBIO: Asegúrate que esta URL sea la correcta desde tu consola de Firebase
            messagingSenderId: "577839297951",
            appId: "1:577839297951:web:7f6dc31ec64db9b3f8f9aa"
        });

        const __app_id = "presupuesto-app";
        const __initial_auth_token = null;
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, deleteDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // ✅ CAMBIO: SDK de Firebase Storage
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        window.firebase = { 
            initializeApp, 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            onSnapshot,
            collection,
            addDoc,
            deleteDoc,
            query,
            orderBy,
            getDocs,
            // ✅ CAMBIO: Funciones de Storage disponibles globalmente
            getStorage,
            ref,
            uploadBytesResumable,
            getDownloadURL
        };
    </script>

    <style>
        /* ... (Tu CSS permanece exactamente igual, no es necesario pegarlo aquí para no alargar la respuesta) ... */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Oswald:wght@200..700&family=Roboto+Mono:wght@100..700&display=swap');
        
        :root {
            --color-primary: #1E3A8A;
            --color-secondary: #3B82F6;
            --color-text: #1F2937;
            --color-header-bg: #F3F4F6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            min-height: 100vh;
            box-sizing: border-box;
        }
        
        .font-title {
            font-family: 'Oswald', sans-serif;
            letter-spacing: 0.05em;
        }
        
        .font-data {
            font-family: 'Roboto Mono', monospace;
        }

        .budget-container {
            width: 100%;
            max-width: 900px;
            min-height: 800px;
            background: white;
            padding: 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem;
            position: relative;
        }

        .budget-content {
            padding: 1rem 2.5rem 0 2.5rem;
            padding-bottom: 10rem;
        }

        [contenteditable="true"]:focus {
            outline: 2px dashed var(--color-secondary);
            padding: 2px;
            border-radius: 4px;
        }
        
        .input-number {
            appearance: textfield;
            -moz-appearance: textfield;
            -webkit-appearance: none;
            text-align: right;
            border: none;
            width: 100%;
            padding: 0;
            margin: 0;
            background-color: transparent;
            font-size: 0.75rem;
        }
        
        .input-number:focus {
            outline: 1px solid var(--color-secondary);
            background-color: var(--color-header-bg);
        }

        .input-client {
            border: none;
            outline: none;
            width: 100%;
            padding: 0;
            margin: 0;
            background: transparent;
            text-align: left;
        }
        
        .input-client:focus {
            outline: 1px dashed var(--color-secondary);
        }

        .table-header-bg {
            background-color: var(--color-primary);
            color: white;
            border-bottom: 1px solid var(--color-secondary);
        }
        
        .line-item:nth-child(even) {
            background-color: #f8f8fa;
        }
        
        .line-item:hover {
            background-color: #f0f0f5 !important;
        }

        .total-due-box {
            background-color: var(--color-primary);
            color: white !important;
        }

        .corporate-footer {
            background-color: var(--color-primary);
            color: white;
            padding: 1.5rem 2.5rem;
            position: absolute;
            bottom: 0;
            width: 100%;
        }
        
        .logo-wrapper {
            cursor: pointer;
            position: relative;
            display: inline-block;
        }
        .logo-wrapper:hover .logo-overlay {
            opacity: 1;
        }
        .logo-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            padding: 5px;
        }

        #saveStatus {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-size: 0.875rem;
        }
        
        #notificationMessage {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            font-size: 0.875rem;
            font-weight: 600;
            text-align: center;
        }

        @media print {
            @page {
                size: A4;
                margin: 0.5in;
            }
            
            .budget-container {
                width: 100%;
                max-width: 100%;
                min-height: 10in;
                box-shadow: none !important;
                padding: 0 !important;
                border-radius: 0 !important;
            }

            .budget-content {
                padding: 0.75in 0.5in 0.5in 0.5in !important;
                padding-bottom: 1in !important;
            }

            .corporate-footer {
                position: fixed !important;
                bottom: 0;
                padding: 1rem 0.5in !important;
                width: calc(100% - 1in) !important;
                box-sizing: border-box;
            }

            .no-print {
                display: none !important;
            }
        }

        .history-thumbnail {
            width: 60px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-right: 10px;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="historyModal" class="no-print hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-blue-700">Historial de Presupuestos</h3>
                <button onclick="closeHistoryModal()" class="text-gray-500 hover:text-gray-700 font-bold text-2xl">&times;</button>
            </div>
            
            <div class="text-center mb-4">
                <button onclick="showClearAllConfirmation()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md text-sm">
                    Limpiar TODO el Historial
                </button>
            </div>
            
            <p class="text-sm text-gray-600 mb-4">Selecciona una plantilla histórica para cargarla en el editor.</p>
            <div id="historyList" class="max-h-80 overflow-y-auto space-y-3 p-2 border rounded-lg bg-gray-50">
                <p class="text-center text-gray-500">Cargando historial...</p>
            </div>
        </div>
    </div>
    
    <div id="clearAllConfirmationModal" class="no-print hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-xs w-full">
            <h3 class="text-xl font-bold mb-4 text-red-600">⚠️ ¡Advertencia Crítica!</h3>
            <p class="mb-6 text-sm">Esta acción es **IRREVERSIBLE** y eliminará todos los registros de tu historial de presupuestos. ¿Estás absolutamente seguro?</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeClearAllConfirmation()" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition text-sm">
                    Cancelar
                </button>
                <button onclick="clearHistoryCollection()" class="py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm">
                    Sí, Limpiar TODO
                </button>
            </div>
        </div>
    </div>

    <div id="saveStatus" class="no-print bg-gray-200 text-gray-700 hidden">Cargando...</div>
    <div id="notificationMessage" class="no-print hidden"></div>
    
    <div class="budget-container mx-auto bg-white shadow-2xl rounded-xl">
        <div class="w-full h-8 bg-blue-700 rounded-t-xl print:h-2" style="background-color: var(--color-primary);"></div>

        <div class="budget-content">
            <div class="no-print mb-6 text-center pt-6">
                <div class="flex flex-wrap justify-center items-center gap-3 mb-3">
                    <button onclick="addLineItem()" class="bg-gray-800 hover:bg-gray-700 text-white font-semibold py-2 px-3 sm:px-4 rounded-lg transition duration-150 shadow-md text-sm sm:text-base">
                        + Partida
                    </button>
                    <button onclick="saveBudget()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-3 sm:px-4 rounded-lg transition duration-150 shadow-md text-sm sm:text-base">
                        Guardar
                    </button>
                    <button onclick="clearAllData()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-3 sm:px-4 rounded-lg transition duration-150 shadow-md text-sm sm:text-base">
                        Limpiar Datos
                    </button>
                    <button onclick="openHistoryModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 sm:px-4 rounded-lg transition duration-150 shadow-md text-sm sm:text-base">
                        Ver Historial
                    </button>
                    <button onclick="exportAsPng()" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-3 sm:px-4 rounded-lg transition duration-150 shadow-md text-sm sm:text-base">
                        Exportar PNG
                    </button>
                    <button onclick="exportPdf()" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 sm:px-4 rounded-lg transition duration-150 shadow-md text-sm sm:text-base">
                        Exportar PDF
                    </button>
                </div>
                
                <div class="inline-flex items-center space-x-4 p-2 bg-gray-100 rounded-lg text-sm text-gray-700">
                    <div class="inline-flex items-center space-x-2">
                        <input type="checkbox" id="toggleTerms" onchange="toggleTermsPrint();" class="w-4 h-4 text-gray-600 bg-gray-200 border-gray-300 rounded focus:ring-gray-500">
                        <label for="toggleTerms">Incluir IVA</label>
                    </div>
                    
                    <div class="inline-flex items-center space-x-2 border-l pl-4">
                        <input type="checkbox" id="togglePaymentDetails" onchange="togglePaymentDetails();" class="w-4 h-4 text-indigo-600 bg-gray-200 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="togglePaymentDetails">Incluir Datos de Pago</label>
                    </div>

                    <div class="inline-flex items-center space-x-2 border-l pl-4">
                        <input type="checkbox" id="toggleBsS" checked onchange="toggleBsSDisplay();" class="w-4 h-4 text-blue-600 bg-gray-200 border-gray-300 rounded focus:ring-blue-500">
                        <label for="toggleBsS">Mostrar Bs.S / Tasa</label>
                    </div>
                </div>
            </div>
            
            <div id="confirmationModal" class="no-print hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-lg shadow-2xl max-w-xs w-full">
                    <h3 class="text-xl font-bold mb-4 text-red-600">Confirmación Necesaria</h3>
                    <p class="mb-6 text-sm">¿Estás seguro de que deseas eliminar esta partida?</p>
                    <div class="flex justify-end space-x-3">
                        <button onclick="closeModal()" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition text-sm">
                            Cancelar
                        </button>
                        <button onclick="confirmRemoval()" class="py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm">
                            Sí, Eliminar
                        </button>
                    </div>
                </div>
            </div>

            <header id="section-header" class="mb-3 sm:mb-4 border-b-2 border-gray-200 pt-4 pb-4">
                <div class="header-main-flex-split flex flex-col sm:flex-row justify-between items-start gap-4">
                    <div id="header-left" class="flex flex-col order-2 sm:order-1 pt-0 flex-grow">
                        <div id="drag-logo" class="relative" style="margin-top: -3.44rem;">
                            <div class="relative group inline-block transition-all duration-100 logo-wrapper" onclick="document.getElementById('logoFileInput').click(); event.stopPropagation();">
                                <div class="logo-overlay no-print">CLIC para cambiar logo</div>
                                <img 
                                    id="companyLogo"
                                    src="https://placehold.co/240x100/1E3A8A/FFFFFF?text=DEIFER" 
                                    alt="Logo FRISERVICE DEIFER C.A." 
                                    class="h-auto object-contain transition duration-300 group-hover:opacity-75 rounded-md"
                                    style="width: 120px; max-height: 100px; display: block;" 
                                    onerror="this.style.display='none'; this.nextElementSibling.style.display='block'; this.previousElementSibling.style.display='none';"
                                >
                                <div id="logoTextFallback" class="text-xl font-bold text-gray-600 mb-2 p-3 rounded-md border border-gray-300 hidden" style="width: 120px; text-align: center;">
                                    LOGO
                                </div>
                            </div>
                            
                            <input type="file" id="logoFileInput" class="hidden" accept="image/*" onchange="handleLogoChange(event)">

                            <div class="no-print mt-2 flex items-center space-x-2">
                                <label for="logoSizeRange" class="text-xs text-gray-600">Tamaño:</label>
                                <input 
                                    type="range" 
                                    id="logoSizeRange" 
                                    min="50" max="300" value="120" 
                                    oninput="resizeLogo(this.value);" 
                                    onmousedown="event.stopPropagation()" 
                                    ontouchstart="event.stopPropagation()" 
                                    class="w-24 h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer range-sm"
                                >
                            </div>
                        </div>

                        <div id="drag-company-info" class="mt-4 w-full">
                            <div class="text-xs sm:text-sm text-gray-500 space-y-1 sm:pt-1">
                                <p id="companyDetails" contenteditable="true" oninput="calculateTotal()">**FRISERVICE DEIFER C.A.** | RIF: J-50709326-3</p>
                                <p id="companyAddress" contenteditable="true" oninput="calculateTotal()">Dirección: [Dirección Completa, Ciudad, País]</p>
                                <p id="companyContact" contenteditable="true" oninput="calculateTotal()">Teléfono: +58 212 987 654 | Email: contacto@deifer.com</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="drag-title-block" class="text-right order-1 sm:order-2 w-full sm:w-auto pt-0 mt-px">
                         <div class="bg-gray-100 p-3 rounded-lg mb-2" style="background-color: var(--color-header-bg);">
                              <h2 class="text-xl sm:text-3xl font-bold text-gray-800 font-title">PRESUPUESTO</h2>
                         </div>
                         
                         <div class="p-2 bg-gray-50 rounded-lg inline-block text-left sm:text-right border border-gray-200 text-xs sm:text-sm">
                              <p class="whitespace-nowrap text-gray-700">
                                   <span class="font-semibold">ID Presupuesto:</span> 
                                   <span id="budgetId" contenteditable="true" oninput="calculateTotal()">PR-2025-001</span> 
                              </p>
                              <p class="whitespace-nowrap text-gray-700">
                                   <span class="font-semibold">Fecha de Emisión:</span> 
                                   <span id="currentDate"></span>
                              </p>
                              <p class="whitespace-nowrap text-gray-700">
                                   <span class="font-semibold">Validez hasta:</span> 
                                   <span id="budgetValidity" contenteditable="true" oninput="calculateTotal()">30 días</span>
                              </p>
                         </div>
                    </div>
                </div>
            </header>
            
            <div class="flex flex-col sm:flex-row justify-start gap-4">
                <section id="section-client-info" class="mb-3 sm:mb-4 p-3 sm:p-4 border rounded-lg bg-gray-50 w-full sm:w-1/2">
                    <h3 class="text-base sm:text-lg font-semibold mb-1 text-gray-700">DIRIGIDO A:</h3>
                    
                    <input 
                        type="text" 
                        id="clientName" 
                        class="input-client font-bold text-lg sm:text-xl text-gray-800" 
                        placeholder="Nombre del Cliente / Empresa Cliente C.A."
                        oninput="calculateTotal()"
                    >

                    <div class="flex items-center text-sm text-gray-500 mt-0.5">
                        <span class="whitespace-nowrap">Persona de Contacto: </span>
                        <input 
                            type="text" 
                            id="clientContact" 
                            class="input-client text-gray-700 ml-1" 
                            placeholder="[Nombre o telf: 0412-1234567]"
                            oninput="formatContactField(this); calculateTotal()"
                        >
                    </div>

                    <div class="flex items-center text-sm text-gray-500 mt-0.5">
                        <span class="whitespace-nowrap">Dirección de Facturación: </span>
                        <input 
                            type="text" 
                            id="clientAddress" 
                            class="input-client text-gray-700 ml-1" 
                            placeholder="[Calle, Ciudad, Código Postal]"
                            oninput="calculateTotal()"
                        >
                    </div>

                    <div class="flex items-center text-sm text-gray-500 mt-0.5">
                        <span id="rifLabel" class="whitespace-nowrap font-semibold">RIF/C.I.:</span>
                        <input 
                            type="text" 
                            id="clientRif" 
                            class="input-client text-gray-700 ml-1 input-rif-ci font-data" 
                            placeholder="[V-12345678]"
                            oninput="formatRif(this); updateRifLabel(this.value); calculateTotal();"
                        >
                    </div>
                </section>
                
                <section id="paymentDetailsSection" class="mb-3 sm:mb-4 p-3 sm:p-4 border rounded-lg bg-gray-50 w-full sm:w-1/2 hidden">
                    <h3 class="text-base sm:text-lg font-semibold mb-1 text-gray-700">DATOS DE PAGO:</h3>
                    
                    <div class="text-sm text-gray-700 space-y-1">
                        <div class="flex justify-between border-b border-gray-200 pb-1">
                            <span class="font-semibold w-1/3">Banco:</span>
                            <input 
                                type="text" 
                                id="paymentBank" 
                                class="input-client text-right w-2/3" 
                                placeholder="Nombre del Banco"
                                oninput="calculateTotal()"
                            >
                        </div>
                        <div class="flex justify-between border-b border-gray-200 pb-1">
                            <span class="font-semibold w-1/3">Móvil:</span>
                            <input 
                                type="text" 
                                id="paymentAccount" 
                                class="input-client text-right w-2/3 font-data" 
                                placeholder="0412-1234567 (Pago Móvil)"
                                oninput="formatPhoneNumber(this); calculateTotal()"
                            >
                        </div>
                        
                        <div class="flex justify-between pb-1">
                            <span class="font-semibold w-1/3">RIF/C.I.:</span>
                            <input 
                                type="text" 
                                id="paymentRif" 
                                class="input-client text-right w-2/3" 
                                placeholder="J-12345678"
                                oninput="calculateTotal()"
                            >
                        </div>
                    </div>
                </section>
            </div>

            <section id="section-line-items" class="mb-6 sm:mb-8 overflow-x-auto shadow-md rounded-lg">
                <table class="w-full border-collapse min-w-[700px] sm:min-w-full">
                    <thead>
                        <tr class="table-header-bg text-xs sm:text-sm font-semibold">
                            <td class="p-2 sm:p-3 w-1/2">DESCRIPCIÓN</td>
                            <td class="p-2 sm:p-3 text-right min-w-[120px] whitespace-nowrap" id="cantHeader">CANT.</td>
                            <td class="p-2 sm:p-3 text-right min-w-[170px] whitespace-nowrap text-green-300" id="precioUnitarioHeader">PRECIO UNITARIO (<span class="text-xs">$</span>)</td>
                            <td class="p-2 sm:p-3 text-right min-w-[160px] whitespace-nowrap bs-col-header" id="bsColHeader">TOTAL (Bs.S)</td>
                        </tr>
                    </thead>
                    <tbody id="lineItems">
                        </tbody>
                </table>
            </section>

            <div id="section-summary-wrapper">
                <div class="flex justify-end">
                    <div class="w-full sm:w-8/12 md:w-7/12 lg:w-6/12 xl:w-5/12">
                        <div class="p-4 border-t-2 border-gray-400">
                            <div class="flex justify-between mb-2 text-sm text-gray-700 bs-line" id="subtotalLine">
                                <span>Subtotal (Bs.S):</span>
                                <span class="font-semibold whitespace-nowrap font-data bs-line" id="subtotal">Bs.S 0,00</span>
                            </div>
                            
                            <div id="taxLine" class="flex justify-between mb-2 text-sm text-gray-700">
                                <span>Impuesto (IVA 
                                    <span contenteditable="true" id="taxRateText" class="text-gray-600 cursor-pointer font-data" oninput="calculateTotal();">16</span>%):
                                </span>
                                <span class="font-semibold whitespace-nowrap font-data bs-line" id="taxAmount">Bs.S 0,00</span>
                            </div>
                            
                            <div id="exchangeRateLine" class="flex justify-between items-center mb-4 pt-2 border-t bs-line">
                                <span class="font-semibold text-gray-700 text-sm">Tasa del día BCV ($):</span>
                                <span contenteditable="true" id="exchangeRateText" class="text-base sm:text-lg font-bold p-1 rounded-md bg-gray-100 cursor-pointer text-gray-800 whitespace-nowrap font-data" oninput="calculateTotal();" title="Tasa del día. Puedes editarla manualmente.">
                                    199.10
                                </span>
                            </div>
                            
                            <div class="flex justify-between text-lg sm:text-xl font-bold pt-2 mt-4 p-2 rounded-lg total-due-box border border-blue-200" id="totalUsdLine">
                                <span id="totalUsdLabel">TOTAL (USD $):</span>
                                <span id="grandTotalUSD" class="whitespace-nowrap font-data">$ 0.00</span>
                            </div>

                            <div class="flex justify-between text-lg sm:text-xl font-bold border-t pt-2 mt-2 bg-gray-200 p-2 rounded-lg text-gray-800 bs-line" id="totalBsSLine">
                                <span>TOTAL (Bs.S):</span>
                                <span id="grandTotalBsS" class="whitespace-nowrap font-data">Bs.S 0,00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="corporate-footer rounded-b-xl">
            <p class="text-center text-xs sm:text-sm font-light">¡GRACIAS POR SU CONFIANZA EN NUESTROS SERVICIOS!</p>
            <p class="text-center text-xs sm:text-sm font-light mt-2">
                <span contenteditable="true" class="hover:bg-blue-800 rounded p-1">Teléfono: +58 212 987 654</span> | 
                <span contenteditable="true" class="hover:bg-blue-800 rounded p-1">Email: contacto@deifer.com</span>
            </p>
        </div>
    </div>

    <script>
        // Variables globales
        let db, auth, storage; // ✅ CAMBIO: Variable para Firebase Storage
        let userId = 'anonymous';
        const DEFAULT_LOGO_URL = "https://placehold.co/240x100/1E3A8A/FFFFFF?text=DEIFER";
        const NEW_DEFAULT_RATE = 199.10;
        const DEFAULT_BUDGET_ID = 'PR-2025-001';
        const lineItemsContainer = document.getElementById('lineItems');
        let subtotalEl = document.getElementById('subtotal');
        let taxAmountEl = document.getElementById('taxAmount');
        let grandTotalBsSEl = document.getElementById('grandTotalBsS');
        let grandTotalUSDEl = document.getElementById('grandTotalUSD');
        let taxRateTextEl = document.getElementById('taxRateText');
        let exchangeRateTextEl = document.getElementById('exchangeRateText');
        let confirmationModal = document.getElementById('confirmationModal');
        let toggleTermsCheckbox = document.getElementById('toggleTerms');
        let taxLineEl = document.getElementById('taxLine');
        let companyLogo = document.getElementById('companyLogo');
        let notificationMessageEl = document.getElementById('notificationMessage');
        let totalUsdLabel = document.getElementById('totalUsdLabel');
        let totalUsdLine = document.getElementById('totalUsdLine');
        let totalBsSLine = document.getElementById('totalBsSLine');
        let subtotalLine = document.getElementById('subtotalLine');
        let bsColHeader = document.getElementById('bsColHeader');
        let precioUnitarioHeader = document.getElementById('precioUnitarioHeader');
        let paymentDetailsSection = document.getElementById('paymentDetailsSection');
        let toggleBsSCheckbox = document.getElementById('toggleBsS');
        let budgetIdElement = document.getElementById('budgetId');
        let clearAllConfirmationModal = document.getElementById('clearAllConfirmationModal');
        let TAX_RATE_DEFAULT = 0.16;
        let itemToRemove = null;

        // Configuración de Firebase
        const budgetDocPath = () => `artifacts/${__app_id}/users/${userId}/budget_template/main_document`;
        const budgetHistoryPath = () => `artifacts/${__app_id}/users/${userId}/budget_history`;

        // Funciones principales
        function setCurrentDate() {
            const today = new Date();
            const dateOptions = { day: '2-digit', month: '2-digit', year: 'numeric' };
            document.getElementById('currentDate').textContent = today.toLocaleDateString('es-ES', dateOptions);
        }

        function formatBsS(value) {
            return "Bs.S " + new Intl.NumberFormat('es-VE', { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
        }

        function formatUSD(value) {
            return "$ " + new Intl.NumberFormat('en-US', { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 4 }).format(value);
        }

        function createLineItemRow(item = { description: 'Mantenimiento', quantity: 1, unit_price: 0 }) {
            const newRow = document.createElement('tr');
            newRow.className = 'line-item border-b border-gray-200 text-sm';
            newRow.innerHTML = `
                <td class="p-2 sm:p-3">
                    <div class="flex justify-between items-start w-full space-x-2">
                        <span contenteditable="true" class="description-text flex-grow min-w-0">${item.description}</span>
                        <button onclick="promptRemoveLineItem(this)" class="no-print text-red-500 hover:text-red-700 delete-btn transition duration-150 rounded-full">
                            &#x1F5D1;
                        </button>
                    </div>
                </td>
                <td class="p-2 sm:p-3 text-right min-w-[120px]">
                    <input type="text" value="${item.quantity}" min="0" class="input-number quantity font-data whitespace-nowrap" oninput="calculateTotal();" onkeypress="return isNumberKey(event)">
                </td>
                <td class="p-2 sm:p-3 text-right min-w-[170px]">
                    <input type="text" value="${item.unit_price}" min="0" step="0.01" class="input-number unit-price text-green-600 font-medium font-data whitespace-nowrap" oninput="calculateTotal();" onkeypress="return isNumberKey(event)">
                </td>
                <td class="p-2 sm:p-3 text-right min-w-[160px] bs-col-data">
                    <span class="total-price font-semibold font-data whitespace-nowrap">Bs.S 0,00</span>
                </td>
            `;
            lineItemsContainer.appendChild(newRow);
            
            newRow.querySelector('.description-text').addEventListener('input', calculateTotal);
            handleDescriptionBlur({ target: newRow.querySelector('.description-text') });
        }

        function handleDescriptionFocus(event) {
            const span = event.target;
            span.classList.remove('text-gray-400');
            if (span.textContent.trim() === 'Mantenimiento') {
                span.textContent = '';
            }
        }

        function handleDescriptionBlur(event) {
            const span = event.target;
            if (span.textContent.trim() === '') {
                span.textContent = 'Mantenimiento';
                span.classList.add('text-gray-400');
            }
        }

        function setupDescriptionListeners() {
            document.querySelectorAll('.line-item').forEach(row => {
                const descriptionSpan = row.querySelector('.description-text');
                descriptionSpan.addEventListener('focus', handleDescriptionFocus);
                descriptionSpan.addEventListener('blur', handleDescriptionBlur);
                if (descriptionSpan.textContent.trim() !== 'Mantenimiento') {
                     descriptionSpan.classList.remove('text-gray-400');
                } else {
                    descriptionSpan.classList.add('text-gray-400');
                }
            });
        }

        function calculateTotal() {
            let totalSubtotalBsS = 0;
            let totalSubtotalUSD = 0;
            
            let taxRateValue = 0;
            if (toggleTermsCheckbox && toggleTermsCheckbox.checked) {
                const rawTaxRate = taxRateTextEl.textContent.trim().replace(',', '.').replace(/[^\d.]/g, '');
                taxRateValue = parseFloat(rawTaxRate) / 100 || TAX_RATE_DEFAULT;
            }
            
            let rawRate = exchangeRateTextEl.textContent.trim().replace(',', '.').replace(/[^\d.]/g, '');
            let exchangeRateValue = parseFloat(rawRate) || 1.0;
            
            if (exchangeRateValue <= 0) exchangeRateValue = 1.0;

            document.querySelectorAll('.line-item').forEach(row => {
                const quantityInput = row.querySelector('.quantity');
                const priceInput = row.querySelector('.unit-price');
                const totalPriceEl = row.querySelector('.total-price');

                // ✅ CAMBIO: Validación numérica robusta
                const cleanQuantity = (quantityInput.value || '0').replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');
                const quantity = parseFloat(cleanQuantity) || 0;

                const cleanPrice = (priceInput.value || '0').replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');
                const unitPriceUSD = parseFloat(cleanPrice) || 0;

                const lineTotalUSD = quantity * unitPriceUSD;
                const lineTotalBsS = lineTotalUSD * exchangeRateValue;

                totalSubtotalBsS += lineTotalBsS;
                totalSubtotalUSD += lineTotalUSD;
                
                if (totalPriceEl) totalPriceEl.textContent = formatBsS(lineTotalBsS);
                
                if (toggleBsSCheckbox && !toggleBsSCheckbox.checked) {
                    if (totalPriceEl) totalPriceEl.textContent = formatUSD(lineTotalUSD);
                }
            });

            const taxAmountBsS = totalSubtotalBsS * taxRateValue;
            const totalWithTaxUSD = totalSubtotalUSD + (totalSubtotalUSD * taxRateValue);

            if (subtotalEl) subtotalEl.textContent = formatBsS(totalSubtotalBsS);
            if (taxAmountEl) taxAmountEl.textContent = formatBsS(taxRateValue > 0 ? taxAmountBsS : 0);
            if (grandTotalBsSEl) grandTotalBsSEl.textContent = formatBsS(totalSubtotalBsS + taxAmountBsS);
            if (grandTotalUSDEl) grandTotalUSDEl.textContent = formatUSD(totalWithTaxUSD);
        }

        function addLineItem() {
            createLineItemRow();
        }
        
        function promptRemoveLineItem(buttonElement) {
            if (lineItemsContainer.children.length > 1) {
                itemToRemove = buttonElement.closest('.line-item');
                confirmationModal.classList.remove('hidden');
            } else {
                console.warn("No se puede eliminar la última partida.");
            }
        }

        function confirmRemoval() {
            if (itemToRemove) {
                itemToRemove.remove();
                itemToRemove = null;
                closeModal();
                calculateTotal();
            }
        }
        
        function closeModal() {
            confirmationModal.classList.add('hidden');
            itemToRemove = null;
        }

        function isNumberKey(evt) {
            const charCode = (evt.which) ? evt.which : evt.keyCode;
            const target = evt.target;
            
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                if (charCode === 46) {
                    if (target.value.indexOf('.') !== -1) {
                        return false;
                    }
                } else {
                    return false;
                }
            }
            return true;
        }

        function toggleTermsPrint() {
            if (toggleTermsCheckbox.checked) {
                taxLineEl.classList.remove('hidden');
                taxRateTextEl.setAttribute('contenteditable', 'true');
            } else {
                taxLineEl.classList.add('hidden');
                taxRateTextEl.setAttribute('contenteditable', 'false');
            }
            calculateTotal();
        }

        function toggleBsSDisplay() {
            const isChecked = toggleBsSCheckbox.checked;
            
            const bsLines = document.querySelectorAll('.bs-line');
            
            bsLines.forEach(line => {
                if (!isChecked) {
                    line.classList.add('hidden');
                } else {
                    line.classList.remove('hidden');
                }
            });
            
            if (!isChecked) {
                precioUnitarioHeader.classList.add('hidden');
                bsColHeader.textContent = 'TOTAL';
                bsColHeader.classList.remove('min-w-[160px]');
                bsColHeader.classList.add('min-w-[170px]');
                
                document.querySelectorAll('.line-item').forEach(row => {
                    const priceInput = row.querySelector('.unit-price');
                    const lineTotalUSD = (parseFloat(row.querySelector('.quantity').value) || 0) * (parseFloat(priceInput.value) || 0);
                    
                    priceInput.closest('td').classList.add('hidden');
                    
                    const bsColDataEl = row.querySelector('.bs-col-data');
                    if (bsColDataEl) {
                         bsColDataEl.textContent = formatUSD(lineTotalUSD);
                    }
                });

            } else {
                precioUnitarioHeader.classList.remove('hidden');
                bsColHeader.textContent = 'TOTAL (Bs.S)';
                bsColHeader.classList.add('min-w-[160px]');
                bsColHeader.classList.remove('min-w-[170px]');
                
                document.querySelectorAll('.line-item').forEach(row => {
                    row.querySelector('.unit-price').closest('td').classList.remove('hidden');
                });
            }
            
            if (subtotalLine && !isChecked) {
                subtotalLine.classList.add('hidden');
            } else if (subtotalLine) {
                subtotalLine.classList.remove('hidden');
            }
            
            if (!isChecked) {
                if (totalUsdLabel) totalUsdLabel.textContent = 'TOTAL:';
                if (totalUsdLine) totalUsdLine.classList.add('mb-0', 'mt-4');
                if (totalUsdLine) totalUsdLine.classList.remove('mt-2');
            } else {
                if (totalUsdLabel) totalUsdLabel.textContent = 'TOTAL (USD $):';
                if (totalUsdLine) totalUsdLine.classList.remove('mb-0', 'mt-4');
                if (totalUsdLine) totalUsdLine.classList.add('mt-2');
            }
            
            calculateTotal();
        }
        
        function togglePaymentDetails() {
            const isChecked = document.getElementById('togglePaymentDetails').checked;
            if (isChecked) {
                paymentDetailsSection.classList.remove('hidden');
            } else {
                paymentDetailsSection.classList.add('hidden');
            }
        }

        function resizeLogo(value) {
            companyLogo.style.width = `${value}px`;
            const logoTextFallback = document.getElementById('logoTextFallback');
            logoTextFallback.style.width = `${value}px`;
        }
        
        // ✅ CAMBIO: Función reescrita para usar Firebase Storage
        function handleLogoChange(event) {
            const file = event.target.files[0];
            if (!file || !userId || !storage) return;

            showNotification('Subiendo logo...', 'info');
            
            // Crear una referencia en Storage. Sobrescribirá el logo anterior del usuario.
            const storageRef = firebase.ref(storage, `logos/${userId}/company_logo`);
            const uploadTask = firebase.uploadBytesResumable(storageRef, file);

            uploadTask.on('state_changed', 
                (snapshot) => {
                    // Opcional: mostrar progreso de subida
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    console.log('Upload is ' + progress + '% done');
                }, 
                (error) => {
                    console.error("Error al subir el logo:", error);
                    showNotification('Error al subir el logo. Revisa la consola.', 'error');
                }, 
                () => {
                    // Subida completada exitosamente
                    firebase.getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
                        console.log('File available at', downloadURL);
                        const logoImg = document.getElementById('companyLogo');
                        const fallbackText = document.getElementById('logoTextFallback');
                        
                        logoImg.src = downloadURL;
                        logoImg.style.display = 'block';
                        fallbackText.style.display = 'none';

                        showNotification('Logo actualizado. Guardando cambios...', 'success');
                        
                        // Guardar automáticamente el presupuesto con la nueva URL del logo
                        saveBudget();
                    });
                }
            );
        }

        function updateRifLabel(value) {
            const rifLabel = document.getElementById('rifLabel');
            const firstChar = value.trim().toUpperCase()[0];
            
            if (['J', 'G', 'C', 'P', 'S'].includes(firstChar)) {
                rifLabel.textContent = 'RIF:';
            } else if (['V', 'E', 'P'].includes(firstChar)) {
                rifLabel.textContent = 'C.I.:';
            } else {
                rifLabel.textContent = 'RIF/C.I.:';
            }
        }

        function formatPhoneNumber(input) {
            let digits = input.value.replace(/[^\d]/g, '');
            if (digits.length > 4) {
                input.value = digits.slice(0, 4) + '-' + digits.slice(4, 11);
            } else {
                input.value = digits;
            }
        }

        function formatContactField(input) {
            let value = input.value;
            if (/^\d/.test(value)) {
                formatPhoneNumber(input);
            }
        }

        function formatRif(input) {
            let value = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            if (value.length > 1 && /[JVGCEP]/.test(value[0])) {
                input.value = (value[0] + '-' + value.substring(1)).slice(0, 12);
            } else {
                input.value = value.slice(0, 12);
            }
        }

        function showNotification(message, type = 'info') {
            let bgColor, textColor;
            if (type === 'success') {
                bgColor = 'bg-green-500';
                textColor = 'text-white';
            } else if (type === 'error') {
                bgColor = 'bg-red-500';
                textColor = 'text-white';
            } else {
                bgColor = 'bg-blue-100';
                textColor = 'text-blue-700';
            }

            notificationMessageEl.textContent = message;
            notificationMessageEl.className = `no-print fixed top-10 left-1/2 transform -translate-x-1/2 z-50 p-3 rounded-lg shadow-2xl font-semibold ${bgColor} ${textColor}`;
            notificationMessageEl.classList.remove('hidden');

            if (type !== 'error') {
                 setTimeout(() => {
                    notificationMessageEl.classList.add('hidden');
                }, 7000);
            }
        }

        function clearAllData() {
            lineItemsContainer.innerHTML = '';
            createLineItemRow();
            
            document.getElementById('companyDetails').textContent = '**FRISERVICE DEIFER C.A.** | RIF: J-50709326-3';
            document.getElementById('companyAddress').textContent = 'Dirección: [Dirección Completa, Ciudad, País]';
            document.getElementById('companyContact').textContent = 'Teléfono: +58 212 987 654 | Email: contacto@deifer.com';
            budgetIdElement.textContent = DEFAULT_BUDGET_ID;
            document.getElementById('budgetValidity').textContent = '30 días';
            
            document.getElementById('taxRateText').textContent = '16';
            document.getElementById('exchangeRateText').textContent = formatUSD(NEW_DEFAULT_RATE).replace("$ ", "");
            
            document.getElementById('clientName').value = '';
            document.getElementById('clientContact').value = '';
            document.getElementById('clientAddress').value = '';
            document.getElementById('clientRif').value = '';
            updateRifLabel('');
            
            document.getElementById('paymentBank').value = '';
            document.getElementById('paymentAccount').value = '';
            document.getElementById('paymentRif').value = '';

            toggleTermsCheckbox.checked = false;
            document.getElementById('togglePaymentDetails').checked = false;
            toggleBsSCheckbox.checked = true;
            
            toggleTermsPrint();
            togglePaymentDetails();
            toggleBsSDisplay();
            calculateTotal();
            
            if (companyLogo) companyLogo.src = DEFAULT_LOGO_URL;
            
            showNotification('¡Datos del presupuesto limpiados! Presiona "Guardar" para guardar este estado vacío.', 'info');
        }

        // Funciones de Firebase
        function collectBudgetData() {
            const lineItems = [];
            document.querySelectorAll('.line-item').forEach(row => {
                const descriptionSpan = row.querySelector('.description-text');
                const quantityInput = row.querySelector('.quantity');
                const priceInput = row.querySelector('.unit-price');
                
                lineItems.push({
                    description: descriptionSpan.textContent.trim(),
                    quantity: parseFloat(quantityInput.value) || 0,
                    unit_price: parseFloat(priceInput.value) || 0,
                });
            });

            // ✅ CAMBIO: Ahora se guarda el `src` de la imagen, que será la URL de Firebase Storage
            return {
                timestamp: new Date().toISOString(),
                content_data: {
                    logo_url: document.getElementById('companyLogo').src,
                    company_details: document.getElementById('companyDetails').textContent.trim(),
                    address: document.getElementById('companyAddress').textContent.trim(),
                    contact: document.getElementById('companyContact').textContent.trim(),
                    budget_id: budgetIdElement.textContent.trim(),
                    validity: document.getElementById('budgetValidity').textContent.trim(),
                    client_name: document.getElementById('clientName').value.trim(),
                    client_contact: document.getElementById('clientContact').value.trim(),
                    client_address: document.getElementById('clientAddress').value.trim(),
                    client_rif: document.getElementById('clientRif').value.trim(),
                    payment_bank: document.getElementById('paymentBank').value.trim(),
                    payment_account: document.getElementById('paymentAccount').value.trim(),
                    payment_rif: document.getElementById('paymentRif').value.trim(),
                    tax_rate_text: document.getElementById('taxRateText').textContent.trim(),
                    exchange_rate_text: document.getElementById('exchangeRateText').textContent.trim()
                },
                line_items: JSON.stringify(lineItems),
                toggle_terms_checked: document.getElementById('toggleTerms').checked,
                toggle_payment_details_checked: document.getElementById('togglePaymentDetails').checked,
                toggle_bs_checked: document.getElementById('toggleBsS').checked
            };
        }

        async function saveBudget() {
            if (!db || !userId) {
                showNotification('Error: Firebase no está configurado correctamente', 'error');
                return;
            }

            const saveStatusEl = document.getElementById('saveStatus');
            saveStatusEl.textContent = 'Guardando...';
            saveStatusEl.classList.remove('bg-green-200', 'text-green-700', 'bg-red-200', 'text-red-700');
            saveStatusEl.classList.add('bg-yellow-200', 'text-yellow-700');
            saveStatusEl.classList.remove('hidden');

            try {
                const data = collectBudgetData();
                await firebase.setDoc(firebase.doc(db, budgetDocPath()), data);
                
                saveStatusEl.textContent = 'Guardado ✓';
                saveStatusEl.classList.remove('bg-yellow-200', 'text-yellow-700', 'bg-red-200', 'text-red-700');
                saveStatusEl.classList.add('bg-green-200', 'text-green-700');
                
                showNotification('Presupuesto guardado exitosamente', 'success');
                
            } catch (error) {
                console.error("Error al guardar en Firestore:", error);
                saveStatusEl.textContent = 'Error al guardar';
                saveStatusEl.classList.remove('bg-yellow-200', 'text-yellow-700', 'bg-green-200', 'text-green-700');
                saveStatusEl.classList.add('bg-red-200', 'text-red-700');
                showNotification('Error al guardar el presupuesto', 'error');
            }
        }

        function loadBudget() {
            if (!db || !userId) return;

            const docRef = firebase.doc(db, budgetDocPath());
            const saveStatusEl = document.getElementById('saveStatus');
            
            firebase.onSnapshot(docRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    applyBudgetData(data);
                    saveStatusEl.textContent = 'Conectado ✓';
                    saveStatusEl.classList.remove('bg-yellow-200', 'text-yellow-700', 'bg-gray-200', 'bg-red-200', 'text-red-700');
                    saveStatusEl.classList.add('bg-green-200', 'text-green-700');
                } else {
                    initialLoadSetup();
                }
            }, (error) => {
                console.error("Error en Firebase:", error);
                saveStatusEl.textContent = 'Error de conexión';
                saveStatusEl.classList.add('bg-red-200', 'text-red-700');
            });
        }

        function applyBudgetData(data) {
            if (!data) return;

            if (data.content_data) {
                const content = data.content_data;
                document.getElementById('companyDetails').textContent = content.company_details || '**FRISERVICE DEIFER C.A.** | RIF: J-50709326-3';
                document.getElementById('companyAddress').textContent = content.address || 'Dirección: [Dirección Completa, Ciudad, País]';
                document.getElementById('companyContact').textContent = content.contact || 'Teléfono: +58 212 987 654 | Email: contacto@deifer.com';
                budgetIdElement.textContent = content.budget_id || DEFAULT_BUDGET_ID;
                document.getElementById('budgetValidity').textContent = content.validity || '30 días';
                
                document.getElementById('clientName').value = content.client_name || '';
                document.getElementById('clientContact').value = content.client_contact || '';
                document.getElementById('clientAddress').value = content.client_address || '';
                document.getElementById('clientRif').value = content.client_rif || '';
                
                document.getElementById('paymentBank').value = content.payment_bank || '';
                document.getElementById('paymentAccount').value = content.payment_account || '';
                document.getElementById('paymentRif').value = content.payment_rif || '';
                
                document.getElementById('taxRateText').textContent = content.tax_rate_text || '16';
                document.getElementById('exchangeRateText').textContent = content.exchange_rate_text || formatUSD(NEW_DEFAULT_RATE).replace("$ ", "");
                
                updateRifLabel(document.getElementById('clientRif').value);
                
                const logoImg = document.getElementById('companyLogo');
                logoImg.src = content.logo_url || DEFAULT_LOGO_URL;
                logoImg.style.display = 'block';
            }

            try {
                const lineItemsArray = JSON.parse(data.line_items || '[]');
                if (Array.isArray(lineItemsArray) && lineItemsArray.length > 0) {
                    lineItemsContainer.innerHTML = '';
                    lineItemsArray.forEach(item => createLineItemRow(item));
                }
            } catch (e) {
                console.error("Error al cargar partidas:", e);
            }

            toggleTermsCheckbox.checked = data.toggle_terms_checked === true;
            document.getElementById('togglePaymentDetails').checked = data.toggle_payment_details_checked === true;
            toggleBsSCheckbox.checked = data.toggle_bs_checked !== false;

            toggleTermsPrint();
            togglePaymentDetails();
            toggleBsSDisplay();
            calculateTotal();
            setupDescriptionListeners();
        }

        // Funciones de exportación (sin cambios)
        async function exportAsPng() {
            showNotification('Preparando exportación PNG...', 'info');
            
            const container = document.querySelector('.budget-container');
            const noPrintElements = document.querySelectorAll('.no-print');
            
            container.classList.add('export-layout');
            noPrintElements.forEach(el => el.style.display = 'none');

            try {
                const canvas = await html2canvas(container, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    useCORS: true
                });
                
                const imageUrl = canvas.toDataURL('image/png');
                const budgetId = document.querySelector('#budgetId').textContent.trim() || 'Presupuesto';
                const fileName = `${budgetId.replace(/[\s\/\\:*?"<>|]/g, '_')}.png`;

                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showNotification('¡Imagen PNG descargada exitosamente!', 'success');

            } catch (error) {
                console.error("Error al exportar a PNG:", error);
                showNotification('Error al generar la imagen PNG', 'error');
            } finally {
                container.classList.remove('export-layout');
                noPrintElements.forEach(el => el.style.display = '');
            }
        }

        async function exportPdf() {
            showNotification('Generando PDF...', 'info');
            
            const container = document.querySelector('.budget-container');
            const noPrintElements = document.querySelectorAll('.no-print');
            
            container.classList.add('export-layout');
            noPrintElements.forEach(el => el.style.display = 'none');

            try {
                const canvas = await html2canvas(container, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    useCORS: true
                });

                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

                const budgetId = document.querySelector('#budgetId').textContent.trim() || 'Presupuesto';
                const fileName = `${budgetId.replace(/[\s\/\\:*?"<>|]/g, '_')}.pdf`;
                pdf.save(fileName);
                
                showNotification('¡PDF descargado exitosamente!', 'success');

            } catch (error) {
                console.error("Error al exportar a PDF:", error);
                showNotification('Error al generar el PDF', 'error');
            } finally {
                container.classList.remove('export-layout');
                noPrintElements.forEach(el => el.style.display = '');
            }
        }

        // Funciones de historial (sin cambios)
        function openHistoryModal() {
            document.getElementById('historyModal').classList.remove('hidden');
            loadHistory();
        }
        
        function closeHistoryModal() {
            document.getElementById('historyModal').classList.add('hidden');
        }

        function showClearAllConfirmation() {
            clearAllConfirmationModal.classList.remove('hidden');
        }
        
        function closeClearAllConfirmation() {
            clearAllConfirmationModal.classList.add('hidden');
        }
        
        async function clearHistoryCollection() {
            showNotification('Funcionalidad completa disponible en versión premium', 'info');
            closeClearAllConfirmation();
        }

        async function loadHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '<p class="text-center text-gray-500">Funcionalidad de historial completa disponible en la versión premium</p>';
        }

        // Inicialización de Firebase
        async function setupAuthAndLoad() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = window.firebase.initializeApp(firebaseConfig);
                db = window.firebase.getFirestore(app);
                auth = window.firebase.getAuth(app);
                storage = window.firebase.getStorage(app); // ✅ CAMBIO: Inicializar Storage
                
                const saveStatusEl = document.getElementById('saveStatus');
                saveStatusEl.classList.remove('hidden');
                saveStatusEl.textContent = 'Conectando...';
                
                await window.firebase.signInAnonymously(auth);
                
                userId = auth.currentUser?.uid;
                
                if (userId) {
                    loadBudget();
                    saveStatusEl.textContent = 'Conectado ✓';
                    saveStatusEl.classList.add('bg-green-200', 'text-green-700');
                }
                
            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                const saveStatusEl = document.getElementById('saveStatus');
                saveStatusEl.textContent = 'Error de conexión';
                saveStatusEl.classList.add('bg-red-200', 'text-red-700');
                
                // Fallback: cargar sin Firebase
                initialLoadSetup();
                showNotification('Modo sin conexión activado. Los datos no se guardarán.', 'info');
            }
        }

        // Inicialización
        function initialLoadSetup() {
            setCurrentDate();
            
            if (lineItemsContainer.children.length === 0) {
                 createLineItemRow();
            }
            
            if (companyLogo) companyLogo.src = DEFAULT_LOGO_URL;
            if (companyLogo) companyLogo.style.display = 'block';
            
            toggleTermsPrint();
            togglePaymentDetails();
            toggleBsSDisplay();
            calculateTotal();
            setupDescriptionListeners();
            
            if (document.getElementById('clientRif')) updateRifLabel(document.getElementById('clientRif').value);
            
            if (exchangeRateTextEl) {
                 exchangeRateTextEl.textContent = formatUSD(NEW_DEFAULT_RATE).replace("$ ", "");
            }
        }

        window.onload = setupAuthAndLoad;
    </script>
</body>
</html>