<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presupuesto Comercial Editable A4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, deleteDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebase = { 
            initializeApp, 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            onSnapshot,
            collection,
            addDoc,
            deleteDoc,
            query,
            orderBy,
            getDocs
        };
        setLogLevel('Debug');
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Oswald:wght@200..700&family=Roboto+Mono:wght@100..700&display=swap');
        
        /* Definición de colores principales inspirados en el diseño */
        :root {
            --color-primary: #1E3A8A; /* Azul Corporativo Oscuro */
            --color-secondary: #3B82F6; /* Azul Brillante */
            --color-text: #1F2937;
            --color-header-bg: #F3F4F6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center; /* Centra verticalmente en la vista */
            padding: 2rem; /* Añade espacio alrededor del contenedor */
            min-height: 100vh; /* Asegura que el body ocupe toda la altura */
            box-sizing: border-box;
        }
        
        /* Estilo para títulos y elementos destacados */
        .font-title {
            font-family: 'Oswald', sans-serif;
            letter-spacing: 0.05em; /* Ligeramente más espaciado */
        }
        
        /* ESTILO CLAVE: Fuente monoespaciada para todos los números */
        .font-data {
            font-family: 'Roboto Mono', monospace;
        }


        /* --- CONTENEDOR PRINCIPAL Y RESPONSIVE --- */
        .budget-container {
            width: 100%;
            max-width: 900px; /* Ancho máximo en desktop */
            min-height: 800px;
            background: white;
            padding: 0; /* Eliminamos el padding aquí y lo manejamos internamente */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem;
            position: relative; 
            transition: all 0.3s ease-in-out;
        }

        /* Contenido que lleva padding y está dentro del contenedor principal */
        /* Añadimos pb-40 para asegurarnos de que el footer no tape el contenido al editar */
        .budget-content {
             padding: 1rem 1rem 0 1rem; /* p-4 en móvil, sin padding inferior */
             padding: 1rem 2.5rem 0 2.5rem; /* Ajuste para desktop */
             padding-bottom: 10rem; /* pb-40 para que el contenido no quede debajo del footer fijo */
        }


        /* Estilo para campos editables (sin borde en modo normal) */
        [contenteditable="true"]:focus {
            outline: 2px dashed var(--color-secondary); 
            padding: 2px;
            border-radius: 4px;
        }
        
        /* Estilo para inputs (números) */
        .input-number {
            appearance: textfield;
            -moz-appearance: textfield;
            -webkit-appearance: none;
            text-align: right;
            border: none;
            width: 100%; 
            padding: 0;
            margin: 0;
            background-color: transparent;
            font-size: 0.875rem; /* AUMENTADO para mejor legibilidad */
        }
        .input-number:focus {
            outline: 1px solid var(--color-secondary); 
            background-color: var(--color-header-bg);
        }

        /* ESTILO CLAVE: Inputs de cliente sin borde y con padding cero */
        .input-client {
            border: none;
            outline: none;
            width: 100%;
            padding: 0;
            margin: 0;
            background: transparent;
            text-align: left; 
        }
        
        .input-client:focus {
            outline: 1px dashed var(--color-secondary);
        }
        
        .input-client::placeholder {
            color: #b0b0b0;
            opacity: 1; 
        }

        /* Estilo para el input del RIF/C.I. que va inmediatamente después del label */
        .input-rif-ci {
            flex-grow: 1; 
            min-width: 0;
            padding: 0 4px;
        }
        .input-rif-ci:focus {
             outline: 1px dashed var(--color-secondary);
        }

        /* --- ESTILOS DE ARRASTRE DE SECCIÓN VERTICAL --- */
        .budget-container > [data-draggable-vertical="true"] {
            cursor: grab;
            transition: box-shadow 0.2s;
            padding: 1rem 0; 
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .budget-container > [data-draggable-vertical="true"]:hover {
            box-shadow: 0 0 0 2px #d1d5db; 
            border-radius: 0.5rem;
        }

        .dragging-vertical {
            opacity: 0.5;
            transform: scale(0.99);
            box-shadow: 0 0 0 4px var(--color-secondary) !important; 
        }

        .drag-over-top {
            border-top: 4px solid var(--color-secondary); 
        }
        .drag-over-bottom {
            border-bottom: 4px solid var(--color-secondary); 
        }
        
        /* Estilo para el indicador de guardado y notificaciones */
        #saveStatus {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-size: 0.875rem;
        }
        
        #notificationMessage {
            position: fixed;
            top: 10px; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            font-size: 0.875rem;
            font-weight: 600;
            text-align: center;
        }

        /* Estilos para el logo y el botón de cambio */
        .logo-wrapper {
            cursor: pointer;
            position: relative;
            display: inline-block;
        }
        .logo-wrapper:hover .logo-overlay {
            opacity: 1;
        }
        .logo-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            padding: 5px;
        }
        
        /* --- ESTILOS DE LA TABLA (Azul Corporativo) --- */
        .table-header-bg {
            background-color: var(--color-primary);
            color: white; 
            border-bottom: 1px solid var(--color-secondary);
        }
        
        .line-item:nth-child(even) {
            background-color: #f8f8fa;
        }
        
        .line-item:hover {
            background-color: #f0f0f5 !important; 
        }

        .input-number, .total-price {
            white-space: nowrap;
        }

        /* AÑADIDO: Aumenta el tamaño del total de la partida */
        .total-price {
            font-size: 0.875rem;
        }

        .total-due-box {
            background-color: var(--color-primary); 
            color: white !important;
        }

        .corporate-footer {
            background-color: var(--color-primary);
            color: white;
            padding: 1.5rem 2.5rem;
            position: absolute;
            bottom: 0;
            width: 100%;
            margin-top: 0;
        }
        
        /* ========================================================================= */
        /* === ESTILOS NUEVOS PARA BOTONES DE ACCIÓN (ESTILO APP) === */
        /* ========================================================================= */
        .action-btn {
            transition: all 0.15s ease-in-out;
        }
        .action-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        /* ========================================================================= */
        /* === NUEVOS ESTILOS PARA INTERRUPTORES (TOGGLES) ESTILO ANDROID === */
        /* ========================================================================= */
        .toggle-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0.5rem;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-align: center;
            height: 100%;
        }

        .toggle-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: var(--color-secondary);
        }

        .toggle-icon-wrapper {
            background-color: var(--color-primary);
            color: white;
            border-radius: 50%;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
            flex-grow: 1;
        }

        .toggle-switch-container {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch-track {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #d1d5db;
            -webkit-transition: .3s;
            transition: .3s;
            border-radius: 24px;
        }

        .toggle-switch-track:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            -webkit-transition: .3s;
            transition: .3s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .peer:checked + .toggle-switch-track {
            background-color: var(--color-secondary);
        }

        .peer:checked + .toggle-switch-track:before {
            -webkit-transform: translateX(20px);
            -ms-transform: translateX(20px);
            transform: translateX(20px);
        }
        
        /* ========================================================================= */
        /* === NUEVOS ESTILOS PARA BOTONES DE PARTIDA (ESTILO ANDROID) === */
        /* ========================================================================= */
        .add-item-fab, .delete-btn-fab {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }

        .add-item-fab {
            background-color: var(--color-secondary);
        }

        .delete-btn-fab {
            background-color: #ef4444;
        }

        .add-item-fab:hover, .delete-btn-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        /* ========================================================================= */
        /* === NUEVOS ESTILOS PARA MODAL DE HISTORIAL ANIMADO Y AMISTOSO === */
        /* ========================================================================= */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes scaleOut {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(0.95); opacity: 0; }
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-entering .modal-overlay {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .modal-entering .modal-content {
            animation: scaleIn 0.3s ease-out forwards;
        }
        
        .modal-leaving .modal-overlay {
            animation: fadeOut 0.2s ease-in forwards;
        }
        .modal-leaving .modal-content {
            animation: scaleOut 0.2s ease-in forwards;
        }
        
        .history-item {
            transition: all 0.2s ease-in-out;
        }
        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        #historyList::-webkit-scrollbar {
            width: 8px;
        }
        #historyList::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #historyList::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }
        #historyList::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* ========================================================================= */
        /* === EXPORTACIÓN A A4 - Consistencia en PDF y JPG === */
        /* ========================================================================= */

        @media print {
            @page {
                size: A4;
                margin: 0.5in;
            }
            .budget-container {
                width: 100%;
                max-width: 100%;
                min-height: 10in;
                box-shadow: none !important;
                padding: 0 !important;
                border-radius: 0 !important;
                position: relative;
            }

            .budget-content {
                padding: 0.75in 0.5in 0.5in 0.5in !important; 
                padding-bottom: 1in !important;
            }

            .corporate-footer {
                position: fixed !important;
                bottom: 0;
                padding: 1rem 0.5in !important;
                width: calc(100% - 1in) !important;
                box-sizing: border-box;
            }

            .no-print, #saveStatus, #notificationMessage {
                display: none !important;
            }
            
            .header-main-flex-split {
                flex-direction: row !important;
            }
            #header-left { order: 1 !important; }
            #drag-title-block { order: 2 !important; }
        }

        .export-layout {
            width: 210mm !important;
            min-height: 297mm !important;
            max-width: none !important;
            padding: 0 !important; 
            box-shadow: none !important;
            border-radius: 0 !important;
            overflow: hidden !important; 
            transform-origin: top left !important; 
            
            .budget-content {
                padding: 0.75in 0.75in 0.75in 0.75in !important; 
                padding-bottom: 1in !important;
            }

            .corporate-footer {
                position: absolute !important;
                bottom: 0;
                width: 100% !important;
                padding: 1.5rem 0.75in !important;
                box-sizing: border-box;
            }

            .header-main-flex-split {
                flex-direction: row !important; 
            }
            #header-left { order: 1 !important; } 
            #drag-title-block { order: 2 !important; } 
        }
        
        .hide-bs-col {
            display: none !important;
        }
        
        .history-thumbnail {
            width: 60px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-right: 10px;
        }

    </style>
</head>
<body class="text-gray-800">
    
    <div id="historyModal" class="no-print hidden fixed inset-0 flex items-center justify-center z-50 p-4">
        <div class="modal-overlay absolute inset-0"></div>
        
        <div class="modal-content bg-white p-6 rounded-2xl shadow-2xl max-w-2xl w-full transform">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-xl font-bold text-gray-800" style="color: var(--color-primary);">Historial de Presupuestos</h3>
                <button onclick="closeHistoryModal()" class="text-gray-400 hover:text-gray-700 font-bold text-2xl transition duration-150">&times;</button>
            </div>
            
            <div class="flex justify-between items-center mb-4">
                 <p class="text-sm text-gray-600">Selecciona una plantilla para cargarla en el editor.</p>
                <button onclick="showClearAllConfirmation()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-lg transition duration-150 shadow-md text-xs">
                    Limpiar Historial
                </button>
            </div>
            
            <div id="historyList" class="max-h-80 overflow-y-auto space-y-3 p-2 border rounded-lg bg-gray-50">
                </div>
            
            <div id="historyEmptyState" class="hidden text-center py-10">
                 <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No hay presupuestos</h3>
                <p class="mt-1 text-sm text-gray-500">Presiona "Guardar" para empezar a crear tu historial.</p>
            </div>
        </div>
    </div>
    <div id="clearAllConfirmationModal" class="no-print hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-xs w-full">
            <h3 class="text-xl font-bold mb-4 text-red-600">⚠️ ¡Advertencia Crítica!</h3>
            <p class="mb-6 text-sm">Esta acción es **IRREVERSIBLE** y eliminará todos los registros de tu historial de presupuestos. ¿Estás absolutamente seguro?</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeClearAllConfirmation()" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition text-sm">
                    Cancelar
                </button>
                <button onclick="clearHistoryCollection()" class="py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm">
                    Sí, Limpiar TODO
                </button>
            </div>
        </div>
    </div>


    <div id="saveStatus" class="no-print bg-gray-200 text-gray-700 hidden">Cargando...</div>
    <div id="notificationMessage" class="no-print hidden"></div>
    
    <div class="budget-container mx-auto bg-white shadow-2xl rounded-xl">

        <div class="w-full h-8 bg-blue-700 rounded-t-xl print:h-2" style="background-color: var(--color-primary);"></div>

        <div class="budget-content">

            <div class="no-print mb-6 text-center pt-6">
                <div class="grid grid-cols-4 sm:grid-cols-7 gap-3 mb-4 text-center">
                    
                    <button onclick="saveBudget()" title="Guardar Cambios" class="action-btn flex flex-col items-center justify-center space-y-1 bg-blue-500 text-white p-3 rounded-2xl shadow-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3l-4-4-4 4z"></path></svg>
                        <span class="text-xs font-medium">Guardar</span>
                    </button>

                    <button onclick="clearAllData()" title="Limpiar Formulario" class="action-btn flex flex-col items-center justify-center space-y-1 bg-yellow-500 text-white p-3 rounded-2xl shadow-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.4 7.6a9.04 9.04 0 00-14.8 0m14.8 0a9.04 9.04 0 01.6 4.4m-15.4 0a9.04 9.04 0 0114.8 0"></path></svg>
                        <span class="text-xs font-medium">Limpiar</span>
                    </button>

                    <button onclick="openHistoryModal()" title="Ver Historial" class="action-btn flex flex-col items-center justify-center space-y-1 bg-blue-600 text-white p-3 rounded-2xl shadow-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="text-xs font-medium">Historial</span>
                    </button>
                    
                    <button onclick="exportAsFunctionalHTML()" title="Exportar como Página Web" class="action-btn flex flex-col items-center justify-center space-y-1 bg-teal-500 text-white p-3 rounded-2xl shadow-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9V3m0 18a9 9 0 009-9m-9 9a9 9 0 00-9-9"></path></svg>
                        <span class="text-xs font-medium">Exportar Web</span>
                    </button>

                    <button onclick="shareViaWhatsApp()" title="Compartir por WhatsApp (Móvil)" class="action-btn flex flex-col items-center justify-center space-y-1 bg-green-500 text-white p-3 rounded-2xl shadow-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12h.01M8 12h.01M12 12h.01M16 12h.01M20 12h.01M4 6h.01M8 6h.01M12 6h.01M16 6h.01M20 6h.01M4 18h.01M8 18h.01M12 18h.01M16 18h.01M20 18h.01"></path></svg>
                        <span class="text-xs font-medium">Compartir</span>
                    </button>

                    <button onclick="exportAsPng()" title="Exportar como PNG" class="action-btn flex flex-col items-center justify-center space-y-1 bg-orange-500 text-white p-3 rounded-2xl shadow-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1-1m5 5v-4.586a2 2 0 00-.586-1.414l-4.586-4.586a2 2 0 00-2.828 0L4 12"></path></svg>
                        <span class="text-xs font-medium">PNG</span>
                    </button>

                    <button onclick="exportPdf()" title="Exportar como PDF" class="action-btn flex flex-col items-center justify-center space-y-1 bg-red-600 text-white p-3 rounded-2xl shadow-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <span class="text-xs font-medium">PDF</span>
                    </button>
                </div>
                
                <div class="grid grid-cols-3 gap-3 sm:gap-4 p-2">
                    
                    <label for="toggleTerms" class="toggle-card">
                        <div class="toggle-icon-wrapper">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"></path></svg>
                        </div>
                        <span class="toggle-label">Incluir IVA</span>
                        <div class="toggle-switch-container">
                             <input type="checkbox" id="toggleTerms" onchange="toggleTermsPrint();" class="sr-only peer">
                             <div class="toggle-switch-track"></div>
                        </div>
                    </label>

                    <label for="togglePaymentDetails" class="toggle-card">
                        <div class="toggle-icon-wrapper">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                        </div>
                        <span class="toggle-label">Datos de Pago</span>
                        <div class="toggle-switch-container">
                             <input type="checkbox" id="togglePaymentDetails" onchange="togglePaymentDetails();" class="sr-only peer">
                             <div class="toggle-switch-track"></div>
                        </div>
                    </label>
                    
                    <label for="toggleBsS" class="toggle-card">
                        <div class="toggle-icon-wrapper">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                        </div>
                        <span class="toggle-label">Mostrar Bs.S / Tasa</span>
                        <div class="toggle-switch-container">
                             <input type="checkbox" id="toggleBsS" checked onchange="toggleBsSDisplay();" class="sr-only peer">
                             <div class="toggle-switch-track"></div>
                        </div>
                    </label>

                </div>
                </div>
            
            <div id="confirmationModal" class="no-print hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-lg shadow-2xl max-w-xs w-full">
                    <h3 class="text-xl font-bold mb-4 text-red-600">Confirmación Necesaria</h3>
                    <p class="mb-6 text-sm">¿Estás seguro de que deseas eliminar esta partida?</p>
                    <div class="flex justify-end space-x-3">
                        <button onclick="closeModal()" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition text-sm">
                            Cancelar
                        </button>
                        <button onclick="confirmRemoval()" class="py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm">
                            Sí, Eliminar
                        </button>
                    </div>
                </div>
            </div>


            <header id="section-header" class="mb-3 sm:mb-4 border-b-2 border-gray-200 pt-4 pb-4"> 
                <div class="header-main-flex-split flex flex-col sm:flex-row justify-between items-start gap-4">
                    
                    <div id="header-left" class="flex flex-col order-2 sm:order-1 pt-0 flex-grow"> 

<div id="drag-logo" class="relative" style="margin-top: -3.44rem;"> <div class="relative group inline-block transition-all duration-100 logo-wrapper" onclick="document.getElementById('logoFileInput').click(); event.stopPropagation();">
                                
                                

<div class="logo-overlay no-print">CLIC para cambiar logo</div>

                                

<img 
                                    id="companyLogo"
                                    src="https://placehold.co/240x100/1E3A8A/FFFFFF?text=DEIFER" 
                                    alt="Logo FRISERVICE DEIFER C.A." 
                                    class="h-auto object-contain transition duration-300 group-hover:opacity-75 rounded-md"
                                    style="width: 120px; max-height: 100px; display: block;" 
                                    onerror="this.style.display='none'; this.nextElementSibling.style.display='block'; this.previousElementSibling.style.display='none';"
                                >
                                
                                

<div id="logoTextFallback" class="text-xl font-bold text-gray-600 mb-2 p-3 rounded-md border border-gray-300 hidden" style="width: 120px; text-align: center;">
                                    LOGO
                                </div>

                            </div>
                            
                            <input type="file" id="logoFileInput" class="hidden" accept="image/*" onchange="handleLogoChange(event)">

                            <div class="no-print mt-2 flex items-center space-x-2">
                                <label for="logoSizeRange" class="text-xs text-gray-600">Tamaño:</label>
                                <input 
                                    type="range" 
                                    id="logoSizeRange" 
                                    min="50" max="300" value="120" 
                                    oninput="resizeLogo(this.value);" 
                                    onmousedown="event.stopPropagation()" 
                                    ontouchstart="event.stopPropagation()" 
                                    class="w-24 h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer range-sm"
                                >
                            </div>
                        </div>

                        <div id="drag-company-info" class="mt-4 w-full"> 
                            <div class="text-xs sm:text-sm text-gray-500 space-y-1 sm:pt-1">
                                <p id="companyDetails" contenteditable="true" oninput="calculateTotal()">**FRISERVICE DEIFER C.A.** | RIF: J-50709326-3</p>
                                <p id="companyAddress" contenteditable="true" oninput="calculateTotal()">Dirección: [Dirección Completa, Ciudad, País]</p>
                                <p id="companyContact" contenteditable="true" oninput="calculateTotal()">Teléfono: +58 212 987 654 | Email: contacto@deifer.com</p>
                            </div>
                        </div>
                    </div>
                    
                    <div 
                        id="drag-title-block" 
                        class="text-right order-1 sm:order-2 w-full sm:w-auto pt-0 mt-px" 

>
                         <div class="bg-gray-100 p-3 rounded-lg mb-2" style="background-color: var(--color-header-bg);">
                             <h2 class="text-xl sm:text-3xl font-bold text-gray-800 font-title">PRESUPUESTO</h2>
                         </div>
                         
                         <div class="p-2 bg-gray-50 rounded-lg inline-block text-left sm:text-right border border-gray-200 text-xs sm:text-sm">
                             <p class="whitespace-nowrap text-gray-700">
                                 <span class="font-semibold">ID Presupuesto:</span> 
                                 <span id="budgetId" contenteditable="true" oninput="calculateTotal()">PR-2025-001</span> 
                             </p>
                             <p class="whitespace-nowrap text-gray-700">
                                 <span class="font-semibold">Fecha de Emisión:</span> 
                                 <span id="currentDate"></span>
                             </p>
                             <p class="whitespace-nowrap text-gray-700">
                                 <span class="font-semibold">Validez hasta:</span> 
                                 <span id="budgetValidity" contenteditable="true" oninput="calculateTotal()">30 días</span>
                             </p>
                         </div>
                    </div>
                </div>
                
            </header>
            
            <div class="flex flex-col sm:flex-row justify-start gap-4">
            
                <section 
                    id="section-client-info" 
                    class="mb-3 sm:mb-4 p-3 sm:p-4 border rounded-lg bg-gray-50 w-full sm:w-1/2" 
                    data-draggable-vertical="true" 
                    data-section-id="client-info" 
                    draggable="true" 
                    ondragstart="handleDragStart(event)" 
                    ondragover="handleDragOver(event)" 
                    ondrop="handleDrop(event)"
                    ondragend="handleDragEnd(event)"
                >
                    <h3 class="text-base sm:text-lg font-semibold mb-1 text-gray-700">DIRIGIDO A:</h3>
                    
                    <input 
                        type="text" 
                        id="clientName" 
                        class="input-client font-bold text-lg sm:text-xl text-gray-800" 
                        placeholder="Cliente / Empresa C.A"
                        oninput="calculateTotal()"
                    >

                    <div class="flex items-center text-sm text-gray-500 mt-0.5">
                        <span class="whitespace-nowrap">Persona de Contacto: </span>
                        <input 
                            type="text" 
                            id="clientContact" 
                            class="input-client text-gray-700 ml-1" 
                            placeholder="Telefono"
                            oninput="formatContactField(this); calculateTotal()"
                        >
                    </div>

                    <div class="flex items-center text-sm text-gray-500 mt-0.5">
                        <span class="whitespace-nowrap">Dirección de Facturación: </span>
                        <input 
                            type="text" 
                            id="clientAddress" 
                            class="input-client text-gray-700 ml-1" 
                            placeholder="Propatria"
                            oninput="calculateTotal()"
                        >
                    </div>

                    <div class="flex items-center text-sm text-gray-500 mt-0.5">
                        <span id="rifLabel" class="whitespace-nowrap font-semibold">RIF/C.I.:</span>
                        <input 
                            type="text" 
                            id="clientRif" 
                            class="input-client text-gray-700 ml-1 input-rif-ci font-data" 
                            placeholder="[V-12345678]"
                            oninput="formatRif(this); updateRifLabel(this.value); calculateTotal();"
                        >
                    </div>
                </section>
                
                <section 
                    id="paymentDetailsSection" 
                    class="mb-3 sm:mb-4 p-3 sm:p-4 border rounded-lg bg-gray-50 w-full sm:w-1/2 hidden" 
                    data-draggable-vertical="true" 
                    data-section-id="payment-details" 
                    draggable="true" 
                    ondragstart="handleDragStart(event)" 
                    ondragover="handleDragOver(event)" 
                    ondrop="handleDrop(event)"
                    ondragend="handleDragEnd(event)"
                >
                    <h3 class="text-base sm:text-lg font-semibold mb-1 text-gray-700">DATOS DE PAGO:</h3>
                    
                    <div class="text-sm text-gray-700 space-y-1">
                        <div class="flex justify-between border-b border-gray-200 pb-1">
                            <span class="font-semibold w-1/3">Banco:</span>
                            <input 
                                type="text" 
                                id="paymentBank" 
                                class="input-client text-right w-2/3" 
                                placeholder="Nombre del Banco"
                                oninput="calculateTotal()"
                            >
                        </div>
                        <div class="flex justify-between border-b border-gray-200 pb-1">
                            <span class="font-semibold w-1/3">Móvil:</span>
                            <input 
                                type="text" 
                                id="paymentAccount" 
                                class="input-client text-right w-2/3 font-data" 
                                placeholder="0412-1234567 (Pago Móvil)"
                                oninput="formatPhoneNumber(this); calculateTotal()"
                            >
                        </div>
                        
                        <div class="flex justify-between pb-1">
                            <span class="font-semibold w-1/3">RIF/C.I.:</span>
                            <input 
                                type="text" 
                                id="paymentRif" 
                                class="input-client text-right w-2/3" 
                                placeholder="J-12345678"
                                oninput="calculateTotal()"
                            >
                        </div>
                    </div>
                </section>
                
            </div>

            <section 
                id="section-line-items" 
                class="mb-6 sm:mb-8 overflow-x-auto shadow-md rounded-lg"
                data-draggable-vertical="true" 
                data-section-id="line-items" 
                draggable="true" 
                ondragstart="handleDragStart(event)" 
                ondragover="handleDragOver(event)" 
                ondrop="handleDrop(event)"
                ondragend="handleDragEnd(event)"
            >
                <table class="w-full border-collapse min-w-[700px] sm:min-w-full">
                    <thead>
                        <tr class="table-header-bg text-xs sm:text-sm font-semibold">
                            <td class="p-2 sm:p-3 w-1/2">DESCRIPCIÓN</td>
                            <td class="p-2 sm:p-3 text-right min-w-[120px] whitespace-nowrap" id="cantHeader">CANT.</td> 
                            <td class="p-2 sm:p-3 text-right min-w-[170px] whitespace-nowrap text-green-300" id="precioUnitarioHeader">PRECIO UNITARIO (<span class="text-xs">$</span>)</td>
                            <td class="p-2 sm:p-3 text-right min-w-[160px] whitespace-nowrap bs-col-header" id="bsColHeader">TOTAL (Bs.S)</td>
                        </tr>
                    </thead>
                    <tbody id="lineItems">
                        </tbody>
                </table>
            </section>

            
            <div 
                id="section-summary-wrapper"
                data-draggable-vertical="true" 
                data-section-id="totals-summary" 
                draggable="true" 
                ondragstart="handleDragStart(event)" 
                ondragover="handleDragOver(event)" 
                ondrop="handleDrop(event)"
                ondragend="handleDragEnd(event)"
            >
                <div class="flex">
                    <div class="w-full">
                        
                        <div class="py-4 border-t-2 border-gray-400">
                            <div class="flex justify-between mb-2 text-sm text-gray-700 px-4" id="subtotalLine">
                                <span id="subtotalLabel">Subtotal (Bs.S):</span>
                                <span class="font-semibold whitespace-nowrap font-data text-base" id="subtotal">Bs.S 0,00</span>
                            </div>
                            
                            <div id="taxLine" class="flex justify-between mb-2 text-sm text-gray-700 px-4">
                                <span>Impuesto (IVA 
                                    <span contenteditable="true" id="taxRateText" class="text-gray-600 cursor-pointer font-data">16</span>%):
                                </span>
                                <span class="font-semibold whitespace-nowrap font-data text-base" id="taxAmount">Bs.S 0,00</span>
                            </div>
                            
                            <div id="exchangeRateLine" class="flex justify-between items-center mb-4 pt-2 border-t bs-line px-4">
                                <span class="font-semibold text-gray-700 text-sm">Tasa del día BCV ($):</span>
                                <span contenteditable="true" id="exchangeRateText" class="text-base sm:text-lg font-bold p-1 rounded-md bg-gray-100 cursor-pointer text-gray-800 whitespace-nowrap font-data" oninput="calculateTotal();" title="Tasa del día. Puedes editarla manually.">
                                    199.10
                                </span>
                            </div>
                            
                            <div class="flex justify-between text-lg sm:text-xl font-bold pt-2 mt-4 p-2 rounded-lg total-due-box border border-blue-200" id="totalUsdLine">
                                <span id="totalUsdLabel">TOTAL (USD $):</span>
                                <span id="grandTotalUSD" class="whitespace-nowrap font-data">$ 0.00</span>
                            </div>

                            <div class="flex justify-between text-lg sm:text-xl font-bold border-t pt-2 mt-2 bg-gray-200 p-2 rounded-lg text-gray-800 bs-line" id="totalBsSLine">
                                <span>TOTAL (Bs.S):</span>
                                <span id="grandTotalBsS" class="whitespace-nowrap font-data">Bs.S 0,00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <section 
                id="termsAndConditionsSection" 
                class="mt-8 sm:mt-12 pt-4 border-t hidden"
                data-draggable-vertical="true" 
                data-section-id="terms" 
                draggable="true" 
                ondragstart="handleDragStart(event)" 
                ondragover="handleDragOver(event)" 
                ondrop="handleDrop(event)"
                ondragend="handleDragEnd(event)"
            >
                <h3 class="text-base sm:text-lg font-semibold mb-2 text-gray-700">Términos y Condiciones:</h3>
                <ul id="termsList" class="text-xs sm:text-sm list-disc list-inside space-y-1 text-gray-600" contenteditable="true" oninput="calculateTotal()">
                    <li>Los precios unitarios se expresan en Dólares Americanos (USD $). La conversión a Bolívares (Bs.S) se realiza según la Tasa del Día.</li>
                    <li>Los precios son válidos por 30 días a partir de la fecha de emisión.</li>
                    <li>Se requiere un pago inicial del 50% para comenzar el trabajo.</li>
                    <li>Aceptación: Firma y fecha a continuación.</li>
                </ul>
            </section>

            <footer 
                id="signatureSection" 
                class="mt-12 sm:mt-16 flex flex-col sm:flex-row justify-between text-xs sm:text-sm text-gray-500 space-y-8 sm:space-y-0 hidden"
                data-draggable-vertical="true" 
                data-section-id="signatures" 
                draggable="true" 
                ondragstart="handleDragStart(event)" 
                ondragover="handleDragOver(event)" 
                ondrop="handleDrop(event)"
                ondragend="handleDragEnd(event)"
            >
                <div>
                    <p>Acepto este presupuesto:</p>
                    <div class="border-t border-gray-400 w-full sm:w-64 mt-8">
                        <p class="pt-1">Firma y Sello del Cliente</p>
                    </div>
                </div>
                <div class="text-left sm:text-right">
                    <p>Por <span id="signatureCompany" contenteditable="true" oninput="calculateTotal()">FRISERVICE DEIFER C.A.</span></p>
                    <div class="border-t border-gray-400 w-full sm:w-64 mt-8">
                        <p class="pt-1">Firma Autorizada</p>
                    </div>
                </div>
            </footer>
        </div>
        
        <div class="corporate-footer rounded-b-xl">
            <p class="text-center text-xs sm:text-sm font-light">¡GRACIAS POR SU CONFIANZA EN NUESTROS SERVICIOS!</p>
            <p class="text-center text-xs sm:text-sm font-light mt-2">
                <span contenteditable="true" class="hover:bg-blue-800 rounded p-1">Teléfono: +58 212 987 654</span> | 
                <span contenteditable="true" class="hover:bg-blue-800 rounded p-1">Email: contacto@deifer.com</span>
            </p>
        </div>

    </div>
    

<script>
        // --- INICIALIZACIÓN Y VARIABLES GLOBALES ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        // MOVIDO: Inicialización de la aplicación y servicios dentro de setupAuthAndLoad
        let db;
        let auth;
        
        let userId = 'anonymous'; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const budgetDocPath = () => `artifacts/${appId}/users/${userId}/budget_template/main_document`;
        const budgetHistoryPath = () => `artifacts/${appId}/users/${userId}/budget_history`; // Ruta de historial
        // RUTA DEL LOGO POR DEFECTO DEL ARTE
        const DEFAULT_LOGO_URL = "https://placehold.co/240x100/1E3A8A/FFFFFF?text=DEIFER";
        const NEW_DEFAULT_RATE = 199.10;
        const DEFAULT_BUDGET_ID = 'PR-2025-001'; // ID por defecto

        const lineItemsContainer = document.getElementById('lineItems');
        // Se mueven las declaraciones de las variables de elementos DOM para que sean accesibles
        // en el contexto global, aunque los valores se asignen al cargar.
        let subtotalEl = document.getElementById('subtotal');
        let taxAmountEl = document.getElementById('taxAmount');
        let grandTotalBsSEl = document.getElementById('grandTotalBsS'); 
        let grandTotalUSDEl = document.getElementById('grandTotalUSD'); 
        let taxRateTextEl = document.getElementById('taxRateText');
        let exchangeRateTextEl = document.getElementById('exchangeRateText');
        let confirmationModal = document.getElementById('confirmationModal');
        let toggleTermsCheckbox = document.getElementById('toggleTerms'); 
        let taxLineEl = document.getElementById('taxLine'); 
        let companyLogo = document.getElementById('companyLogo');
        let notificationMessageEl = document.getElementById('notificationMessage');
        let totalUsdLabel = document.getElementById('totalUsdLabel');
        let totalUsdLine = document.getElementById('totalUsdLine');
        let totalBsSLine = document.getElementById('totalBsSLine');
        let subtotalLine = document.getElementById('subtotalLine');
        let bsColHeader = document.getElementById('bsColHeader');
        let precioUnitarioHeader = document.getElementById('precioUnitarioHeader');
        let paymentDetailsSection = document.getElementById('paymentDetailsSection');
        let toggleBsSCheckbox = document.getElementById('toggleBsS');
        let budgetIdElement = document.getElementById('budgetId');
        let clearAllConfirmationModal = document.getElementById('clearAllConfirmationModal'); // NUEVA MODAL


        let TAX_RATE_DEFAULT = 0.16;
        let itemToRemove = null;
        let draggedItemVertical = null; 
        
        // --- CÓDIGO JS COMPLETO ---
        
        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        // REMOVED: debouncedSaveBudget is no longer needed

        function collectBudgetData() {
            const lineItems = [];
            document.querySelectorAll('.line-item').forEach(row => {
                const descriptionSpan = row.querySelector('.description-text');
                const quantityInput = row.querySelector('.quantity');
                const priceInput = row.querySelector('.unit-price'); 
                
                // Usamos parseFloat para obtener el valor numérico de los campos type="text"
                lineItems.push({
                    description: descriptionSpan.textContent.trim(),
                    quantity: parseFloat(quantityInput.value) || 0,
                    unit_price: parseFloat(priceInput.value) || 0,
                });
            });

            const sectionOrder = Array.from(document.querySelectorAll('.budget-container > .budget-content > [data-draggable-vertical="true"]')).map(el => el.id);
            // Asegura que los términos se guarden como un array de strings, respetando el formato de lista
            const termsListElement = document.getElementById('termsList');
            const termsListItems = Array.from(termsListElement.children).length > 0
                ? Array.from(termsListElement.children).map(li => li.textContent.trim())
                : [termsListElement.textContent.trim()];

            // Lee los valores de los nuevos inputs del cliente
            const clientNameInput = document.getElementById('clientName');
            const clientContactInput = document.getElementById('clientContact');
            const clientAddressInput = document.getElementById('clientAddress');
            const clientRifInput = document.getElementById('clientRif');
            
            // Lee los valores de los nuevos inputs de pago
            const paymentBankInput = document.getElementById('paymentBank');
            const paymentAccountInput = document.getElementById('paymentAccount');
            const paymentRifInput = document.getElementById('paymentRif');


            return {
                timestamp: new Date().toISOString(),
                header_layout: {
                    logo: { 
                        width: document.getElementById('companyLogo').style.width
                    },
                },
                content_data: {
                    logo_url: document.getElementById('companyLogo').src, 
                    company_details: document.getElementById('companyDetails').textContent.trim(),
                    address: document.getElementById('companyAddress').textContent.trim(),
                    contact: document.getElementById('companyContact').textContent.trim(),
                    budget_id: budgetIdElement.textContent.trim(),
                    validity: document.getElementById('budgetValidity').textContent.trim(),
                    // Cliente
                    client_name: clientNameInput.value.trim(),
                    client_contact: clientContactInput.value.trim(),
                    client_address: clientAddressInput.value.trim(),
                    client_rif: clientRifInput.value.trim(),
                    // Pago
                    payment_bank: paymentBankInput.value.trim(),
                    payment_account: paymentAccountInput.value.trim(),
                    payment_rif: paymentRifInput.value.trim(),
                    
                    terms: JSON.stringify(termsListItems),
                    signature_company: document.getElementById('signatureCompany').textContent.trim(),
                    tax_rate_text: document.getElementById('taxRateText').textContent.trim(),
                    exchange_rate_text: document.getElementById('exchangeRateText').textContent.trim()
                },
                line_items: JSON.stringify(lineItems),
                section_order: JSON.stringify(sectionOrder),
                toggle_terms_checked: document.getElementById('toggleTerms').checked,
                toggle_payment_details_checked: document.getElementById('togglePaymentDetails').checked,
                toggle_bs_checked: document.getElementById('toggleBsS').checked // NUEVO ESTADO GUARDADO
            };
        }
        
        async function saveBudget() {
            if (!db || !userId) return; 

            const saveStatusEl = document.getElementById('saveStatus');
            saveStatusEl.textContent = 'Guardando...';
            saveStatusEl.classList.remove('bg-green-200', 'text-green-700', 'bg-red-200', 'text-red-700');
            saveStatusEl.classList.add('bg-yellow-200', 'text-yellow-700');

            try {
                // LÓGICA CLAVE: Actualiza el ID antes de guardar
                // Si el ID actual NO es el ID por defecto, lo incrementamos.
                const currentId = budgetIdElement.textContent.trim();
                if (currentId.startsWith('PR-2025-')) {
                    const nextId = await getNextBudgetId();
                    budgetIdElement.textContent = nextId;
                } else {
                    // Si el usuario lo cambió a mano, no lo forzamos, solo guardamos.
                }

                const data = collectBudgetData();
                // 1. Guarda la versión actual
                await firebase.setDoc(firebase.doc(db, budgetDocPath()), data);
                
                // 2. Registra una copia en el historial
                await registerBudgetInHistory(); 
                
                saveStatusEl.textContent = 'Guardado';
                saveStatusEl.classList.remove('bg-yellow-200', 'text-yellow-700', 'bg-red-200', 'text-red-700');
                saveStatusEl.classList.add('bg-green-200', 'text-green-700');
                
            } catch (error) {
                console.error("Error al guardar en Firestore:", error);
                saveStatusEl.textContent = 'Error al guardar';
                saveStatusEl.classList.remove('bg-yellow-200', 'text-yellow-700', 'bg-green-200', 'text-green-700');
                saveStatusEl.classList.add('bg-red-200', 'text-red-700');
            }
        }
        
        // DELETED: const debouncedSaveBudget = debounce(saveBudget, 3000); 

        function loadBudget() {
            if (!db || !userId) return;

            const docRef = firebase.doc(db, budgetDocPath());
            const saveStatusEl = document.getElementById('saveStatus');
            
            firebase.onSnapshot(docRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    applyBudgetData(data);
                    saveStatusEl.textContent = 'Listo';
                    saveStatusEl.classList.remove('bg-yellow-200', 'text-yellow-700', 'bg-gray-200', 'bg-red-200', 'text-red-700');
                    saveStatusEl.classList.add('bg-green-200', 'text-green-700');
                    console.log("Datos cargados exitosamente.");
                } else {
                    console.log("No hay datos guardados, usando valores por defecto.");
                    
                    // LÓGICA CLAVE: Si no hay documento principal, carga el ID de secuencia del historial.
                    const nextId = await getNextBudgetId(); 
                    initialLoadSetup(nextId);
                }
            }, (error) => {
                console.error("Error en onSnapshot (carga en tiempo real):", error);
                saveStatusEl.textContent = 'Error de carga';
                saveStatusEl.classList.remove('bg-yellow-200', 'text-yellow-700', 'bg-gray-200', 'bg-green-200', 'text-green-700');
                saveStatusEl.classList.add('bg-red-200', 'text-red-700');
            });
        }
        
        // FUNCIÓN NUEVA: Obtiene el siguiente ID de presupuesto
        async function getNextBudgetId() {
            if (!db || !userId) return DEFAULT_BUDGET_ID;

            try {
                // Buscamos todos los documentos en el historial
                const q = firebase.query(firebase.collection(db, budgetHistoryPath()));
                const querySnapshot = await firebase.getDocs(q);
                
                // El número de documentos en el historial es el índice N, el siguiente ID es N + 1
                const count = querySnapshot.size;
                
                // Formateamos el número (ej: 1 -> 002, 10 -> 011)
                const nextNumber = count + 1;
                const formattedNumber = String(nextNumber).padStart(3, '0');
                
                return `PR-2025-${formattedNumber}`;
            } catch (error) {
                console.error("Error obteniendo el conteo del historial:", error);
                return DEFAULT_BUDGET_ID;
            }
        }
        
        function applyBudgetData(data) {
            if (!data) return;

            const logoImg = document.getElementById('companyLogo');
            const logoTextFallback = document.getElementById('logoTextFallback');
            
            const clientNameInput = document.getElementById('clientName');
            const clientContactInput = document.getElementById('clientContact');
            const clientAddressInput = document.getElementById('clientAddress');
            const clientRifInput = document.getElementById('clientRif');
            
            const paymentBankInput = document.getElementById('paymentBank');
            const paymentAccountInput = document.getElementById('paymentAccount');
            const paymentRifInput = document.getElementById('paymentRif');
            
            const togglePaymentDetailsCheckbox = document.getElementById('togglePaymentDetails');
            const toggleBsSCheckbox = document.getElementById('toggleBsS');
            const rifLabel = document.getElementById('rifLabel');


            if (data.content_data) {
                const content = data.content_data;
                document.getElementById('companyDetails').textContent = content.company_details || '**FRISERVICE DEIFER C.A.** | RIF: J-50709326-3';
                document.getElementById('companyAddress').textContent = content.address || 'Dirección: [Dirección Completa, Ciudad, País]';
                document.getElementById('companyContact').textContent = content.contact || 'Teléfono: +58 212 987 654 | Email: contacto@deifer.com';
                budgetIdElement.textContent = content.budget_id || DEFAULT_BUDGET_ID;
                document.getElementById('budgetValidity').textContent = content.budgetValidity || '30 días';
                
                // Carga de los valores de los nuevos inputs (Cliente)
                clientNameInput.value = content.client_name || '';
                clientContactInput.value = content.client_contact || '';
                clientAddressInput.value = content.client_address || '';
                clientRifInput.value = content.client_rif || '';
                
                // Carga de los valores de los nuevos inputs (Pago)
                paymentBankInput.value = content.payment_bank || '';
                paymentAccountInput.value = content.payment_account || '';
                paymentRifInput.value = content.payment_rif || '';
                
                document.getElementById('signatureCompany').textContent = content.signature_company || 'FRISERVICE DEIFER C.A.';
                document.getElementById('taxRateText').textContent = content.tax_rate_text || '16';
                document.getElementById('exchangeRateText').textContent = content.exchange_rate_text || formatUSD(NEW_DEFAULT_RATE).replace("$ ", ""); // Usar el nuevo valor por defecto
                
                // Lógica de RIF/C.I. al cargar (si ya hay un valor guardado)
                updateRifLabel(clientRifInput.value);
                
                // Configurar logo: Carga el logo guardado o usa el logo por defecto.
                logoImg.src = content.logo_url || DEFAULT_LOGO_URL;
                
                // Intentamos mostrar la imagen. El evento onerror la oculta y muestra el fallback si falla.
                logoImg.style.display = 'block'; 
                logoTextFallback.style.display = 'none'; 
                
                // Bloque Try/Catch para Términos (Se mantiene oculto pero guarda datos)
                try {
                    const termsArray = JSON.parse(content.terms);
                    const termsListEl = document.getElementById('termsList');
                    // Limpia y reconstruye la lista si hay elementos guardados
                    if (Array.isArray(termsArray) && termsArray.length > 0) {
                        termsListEl.innerHTML = termsArray.map(item => `<li>${item}</li>`).join('');
                        termsListEl.setAttribute('contenteditable', 'true');
                    } else {
                         // Si no hay datos, usa el HTML por defecto
                         document.getElementById('termsList').innerHTML = `
                             <li>Los precios unitarios se expresan en Dólares Americanos (USD $). La conversión a Bolívares (Bs.S) se realiza según la Tasa del Día.</li>
                             <li>Los precios son válidos por 30 días a partir de la fecha de emisión.</li>
                             <li>Se requiere un pago inicial del 50% para comenzar el trabajo.</li>
                             <li>Aceptación: Firma y fecha a continuación.</li>
                         `;
                    }
                } catch (e) {
                    console.error("Error al parsear términos:", e);
                }
            }

            // Bloque Try/Catch para Partidas
            try {
                const lineItemsArray = JSON.parse(data.line_items || '[]');
                if (Array.isArray(lineItemsArray) && lineItemsArray.length > 0) {
                    lineItemsContainer.innerHTML = '';
                    lineItemsArray.forEach(item => createLineItemRow(item));
                }
            } catch (e) {
                console.error("Error al parsear line items:", e);
            }

            if (data.header_layout && data.header_layout.logo) {
                const layout = data.header_layout;
                const logoWidth = layout.logo.width || '120px';
                document.getElementById('companyLogo').style.width = logoWidth;
                document.getElementById('logoSizeRange').value = parseInt(logoWidth) || 120;
            }

            try {
                const sectionsToReorder = JSON.parse(data.section_order || '[]');
                const container = document.querySelector('.budget-content');
                if (Array.isArray(sectionsToReorder) && sectionsToReorder.length > 0) {
                    sectionsToReorder.forEach(id => {
                        const section = document.getElementById(id);
                        // Asegurarse de que el elemento esté dentro del contenedor de contenido
                        if (section && section.closest('.budget-content') === container) {
                            container.appendChild(section);
                        }
                    });
                }
            } catch (e) {
                 // FIX: Se corrigió la referencia aquí, asegurando que se use sectionsToReorder
                 console.error("Error al restaurar orden de secciones:", e);
            }
            
            const isCheckedIVA = data.toggle_terms_checked === true;
            toggleTermsCheckbox.checked = isCheckedIVA;
            toggleTermsPrint(); // Lógica de IVA
            
            const isCheckedPayment = data.toggle_payment_details_checked === true;
            togglePaymentDetailsCheckbox.checked = isCheckedPayment;
            togglePaymentDetails(); // Lógica de Datos de Pago
            
            const isCheckedBsS = data.toggle_bs_checked !== false; // Por defecto es TRUE if not defined
            toggleBsSCheckbox.checked = isCheckedBsS;
            toggleBsSDisplay(); // NUEVA LÓGICA DE Bs.S

            calculateTotal();
            setupDescriptionListeners();
            setCurrentDate();
        }
        
        // --- LÓGICA DE HISTORIAL (CON ANIMACIONES Y FIX) ---
        
        function openHistoryModal() {
            const modal = document.getElementById('historyModal');
            modal.classList.remove('hidden');
            modal.classList.add('modal-entering');
            modal.addEventListener('animationend', () => {
                modal.classList.remove('modal-entering');
            }, { once: true });
            
            loadHistory();
        }

        function closeHistoryModal() {
            const modal = document.getElementById('historyModal');
            modal.classList.add('modal-leaving');
            modal.addEventListener('animationend', () => {
                modal.classList.add('hidden');
                modal.classList.remove('modal-leaving');
            }, { once: true });
        }
        
        // NUEVAS FUNCIONES PARA CONFIRMACIÓN DE LIMPIEZA TOTAL
        function showClearAllConfirmation() {
            clearAllConfirmationModal.classList.remove('hidden');
        }
        
        function closeClearAllConfirmation() {
            clearAllConfirmationModal.classList.add('hidden');
        }
        
        // FUNCIÓN CLAVE: Elimina TODOS los documentos de la colección de historial
        async function clearHistoryCollection() {
            if (!db || !userId) return;

            showNotification('Limpiando historial... Esto puede tardar unos segundos.', 'error');
            
            try {
                const q = firebase.query(firebase.collection(db, budgetHistoryPath()));
                const querySnapshot = await firebase.getDocs(q);
                
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(firebase.deleteDoc(firebase.doc(db, budgetHistoryPath(), doc.id)));
                });
                
                await Promise.all(deletePromises);
                
                showNotification('Historial completamente limpio. Presiona "Guardar" para reiniciar la numeración.', 'success');
                closeClearAllConfirmation();
                loadHistory(); // Recarga la lista para mostrar el historial vacío
                
                // Reiniciamos el ID actual a 001 y forzamos la carga inicial
                budgetIdElement.textContent = DEFAULT_BUDGET_ID;
                clearAllData(); // Llamamos a limpiar los datos para que el ID se aplique correctamente al siguiente presupuesto

            } catch (error) {
                console.error("Error al limpiar el historial:", error);
                showNotification("Error al limpiar el historial. Revisa la consola.", 'error');
            }
        }
        
        // FUNCIÓN CORREGIDA
        async function loadHistory() {
            const historyList = document.getElementById('historyList');
            const emptyState = document.getElementById('historyEmptyState');
            historyList.innerHTML = ''; // Limpiar siempre
            
            try {
                // MODIFICACIÓN CRÍTICA: Se elimina el orderBy para evitar el error de índice en Firestore.
                const q = firebase.query(firebase.collection(db, budgetHistoryPath()));
                
                const querySnapshot = await firebase.getDocs(q);
                let historyItems = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    historyItems.push({
                        id: doc.id,
                        budgetId: data.content_data?.budget_id || 'N/A',
                        clientName: data.content_data?.client_name || 'Cliente Genérico',
                        timestamp: data.timestamp,
                        image: data.thumbnail_image || '',
                        data: data
                    });
                });

                // MODIFICACIÓN CRÍTICA: Ordenamos los resultados en el navegador (cliente) en lugar de en la base de datos.
                historyItems.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                if (historyItems.length === 0) {
                    historyList.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    return;
                }
                
                historyList.classList.remove('hidden');
                emptyState.classList.add('hidden');
                
                historyItems.forEach(item => {
                    const date = new Date(item.timestamp).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short' });
                    const thumbnail = item.image ? 
                        `<img src="${item.image}" alt="Preview" class="history-thumbnail flex-shrink-0">` : 
                        `<div class="history-thumbnail flex items-center justify-center bg-gray-200 text-gray-500 text-xs flex-shrink-0">No IMG</div>`;
                    
                    const itemHtml = `
                        <div class="history-item bg-white p-3 rounded-lg border flex justify-between items-center shadow-sm">
                            <div class="flex items-center min-w-0">
                                ${thumbnail}
                                <div class="text-left text-sm">
                                    <p class="font-semibold text-gray-800 truncate" title="${item.clientName}">Cliente: ${item.clientName}</p>
                                    <p class="text-xs text-gray-500">ID: ${item.budgetId} | ${date}</p>
                                </div>
                            </div>
                            <div class="flex space-x-2 flex-shrink-0">
                                <button onclick="loadHistoricalBudget('${item.id}')" class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold px-3 py-1 rounded-md transition">Cargar</button>
                                <button onclick="deleteHistoricalBudget('${item.id}')" class="bg-red-500 hover:bg-red-600 text-white text-xs font-semibold px-3 py-1 rounded-md transition">Eliminar</button>
                            </div>
                        </div>
                    `;
                    historyList.innerHTML += itemHtml;
                });

            } catch (error) {
                console.error("Error al cargar historial:", error);
                historyList.innerHTML = '<p class="text-center text-red-500">Error al cargar el historial. Revisa la consola.</p>';
            }
        }
        
        async function loadHistoricalBudget(docId) {
            try {
                const docRef = firebase.doc(db, budgetHistoryPath(), docId);
                const docSnap = await firebase.getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    applyBudgetData(data);
                    showNotification(`Presupuesto "${data.content_data?.budget_id}" cargado exitosamente.`, 'success');
                    closeHistoryModal();
                    await firebase.setDoc(firebase.doc(db, budgetDocPath()), data);
                } else {
                    showNotification("El presupuesto histórico no existe.", 'error');
                }
            } catch (error) {
                console.error("Error al cargar presupuesto histórico:", error);
                showNotification("Error al cargar el presupuesto.", 'error');
            }
        }
        
        async function deleteHistoricalBudget(docId) {
            try {
                await firebase.deleteDoc(firebase.doc(db, budgetHistoryPath(), docId));
                showNotification("Presupuesto eliminado del historial.", 'success');
                const nextId = await getNextBudgetId();
                if (budgetIdElement) budgetIdElement.textContent = nextId;
                loadHistory();
            } catch (error) {
                console.error("Error al eliminar presupuesto:", error);
                showNotification("Error al eliminar el presupuesto.", 'error');
            }
        }
        
        async function registerBudgetInHistory() {
            if (!db || !userId) return;

            const thumbnailImage = await captureThumbnail();
            
            try {
                const data = collectBudgetData();
                data.thumbnail_image = thumbnailImage; 
                await firebase.addDoc(firebase.collection(db, budgetHistoryPath()), data);
                console.log("Presupuesto registrado en el historial.");
            } catch (error) {
                console.error("Error al registrar en el historial:", error);
            }
        }
        
        async function captureThumbnail() {
            const container = document.querySelector('.budget-container');
            const originalStyle = container.getAttribute('style') || '';
            const originalTransform = container.style.transform;
            const originalWidth = container.style.width;

            container.style.width = '300px'; 
            container.style.transform = 'scale(0.35)';
            container.style.transformOrigin = 'top left';

            try {
                const canvas = await html2canvas(container, {
                    backgroundColor: '#ffffff',
                    scale: 1,
                    useCORS: true,
                    allowTaint: true,
                    height: 500
                });
                return canvas.toDataURL('image/png', 0.8);
            } catch (error) {
                console.error("Error capturando la miniatura:", error);
                return '';
            } finally {
                container.style.width = originalWidth;
                container.style.transform = originalTransform;
                container.style.transformOrigin = 'top left';
                container.setAttribute('style', originalStyle);
            }
        }
        
        // --- FIN LÓGICA DE HISTORIAL ---
        
        // --- LÓGICA DE LIMPIEZA DE DATOS ---
        function clearAllData() {
            // 1. Limpiar campos de la tabla
            lineItemsContainer.innerHTML = '';
            createLineItemRow(); // Dejar una fila vacía
            
            // 2. Limpiar campos de información
            document.getElementById('companyDetails').textContent = '**FRISERVICE DEIFER C.A.** | RIF: J-50709326-3';
            document.getElementById('companyAddress').textContent = 'Dirección: [Dirección Completa, Ciudad, País]';
            document.getElementById('companyContact').textContent = 'Teléfono: +58 212 987 654 | Email: contacto@deifer.com';
            budgetIdElement.textContent = DEFAULT_BUDGET_ID; // Usar ID por defecto
            document.getElementById('budgetValidity').textContent = '30 días';
            document.getElementById('signatureCompany').textContent = 'FRISERVICE DEIFER C.A.';
            
            document.getElementById('taxRateText').textContent = '16';
            document.getElementById('exchangeRateText').textContent = formatUSD(NEW_DEFAULT_RATE).replace("$ ", "");
            
            // 3. Limpiar Inputs de Cliente
            document.getElementById('clientName').value = '';
            document.getElementById('clientContact').value = '';
            document.getElementById('clientAddress').value = '';
            document.getElementById('clientRif').value = '';
            updateRifLabel(''); // Restablece la etiqueta RIF/C.I.
            
            // 4. Limpiar Inputs de Pago
            document.getElementById('paymentBank').value = '';
            document.getElementById('paymentAccount').value = '';
            document.getElementById('paymentRif').value = '';

            // 5. Restablecer Checkboxes
            toggleTermsCheckbox.checked = false;
            document.getElementById('togglePaymentDetails').checked = false;
            toggleBsSCheckbox.checked = true;
            
            // 6. Ejecutar lógica visual y cálculo
            toggleTermsPrint();
            togglePaymentDetails();
            toggleBsSDisplay();
            calculateTotal();
            
            // 7. NO RESTABLECER EL LOGO
            // if (companyLogo) companyLogo.src = DEFAULT_LOGO_URL; // ESTA LÍNEA FUE ELIMINADA
            
            // 8. Notificar
            showNotification('¡Datos del presupuesto limpiados! El logo se ha mantenido. Presiona "Guardar" para registrar este estado.', 'info');
        }
        
        
        function getDraggableSection(element) {
            // Buscamos el elemento arrastrable que esté directamente dentro de .budget-content
            while (element && element !== document.body) {
                const parent = element.parentElement;
                if (element.getAttribute('data-draggable-vertical') === 'true' && parent && parent.classList.contains('budget-content')) {
                    return element;
                }
                element = parent;
            }
            return null;
        }

        function handleDragStart(e) {
            draggedItemVertical = getDraggableSection(e.target);
            if (draggedItemVertical) {
                e.dataTransfer.setData('text/plain', draggedItemVertical.dataset.sectionId);
                setTimeout(() => { draggedItemVertical.classList.add('dragging-vertical'); }, 0); 
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            let targetItem = getDraggableSection(e.target);
            document.querySelectorAll('.drag-over-top, .drag-over-bottom').forEach(el => {
                el.classList.remove('drag-over-top', 'drag-over-bottom');
            });
            if (targetItem && targetItem !== draggedItemVertical) {
                const rect = targetItem.getBoundingClientRect();
                const y = e.clientY - rect.top;
                if (y < rect.height / 2) {
                    targetItem.classList.add('drag-over-top');
                } else {
                    targetItem.classList.add('drag-over-bottom');
                }
                e.dataTransfer.dropEffect = 'move';
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            document.querySelectorAll('.dragging-vertical, .drag-over-top, .drag-over-bottom').forEach(el => {
                el.classList.remove('dragging-vertical', 'drag-over-top', 'drag-over-bottom');
            });

            let targetItem = getDraggableSection(e.target);

            if (draggedItemVertical && targetItem && draggedItemVertical !== targetItem) {
                const rect = targetItem.getBoundingClientRect();
                const y = e.clientY - rect.top;
                const parentContainer = document.querySelector('.budget-content');

                if (y < rect.height / 2) {
                    parentContainer.insertBefore(draggedItemVertical, targetItem);
                } else {
                    parentContainer.insertBefore(draggedItemVertical, targetItem.nextSibling);
                }
                // REMOVED: No guardar automáticamente al arrastrar
            }
            draggedItemVertical = null;
        }
        
        function handleDragEnd(e) {
             document.querySelectorAll('.dragging-vertical, .drag-over-top, .drag-over-bottom').forEach(el => {
                el.classList.remove('dragging-vertical', 'drag-over-top', 'drag-over-bottom');
            });
            draggedItemVertical = null;
        }

        function resizeLogo(value) {
            companyLogo.style.width = `${value}px`;
            const logoTextFallback = document.getElementById('logoTextFallback');
            logoTextFallback.style.width = `${value}px`;
            // REMOVED: No guardar automáticamente al redimensionar
        }

        // --- FUNCIÓN AGREGADA PARA CARGA DE LOGO ---
        function handleLogoChange(event) {
            const file = event.target.files[0];
            if (!file) return;

            showNotification('Cargando nuevo logo. Presiona "Guardar" para hacerlo permanente.', 'info');

            const reader = new FileReader();
            reader.onload = (e) => {
                const newLogoUrl = e.target.result;
                const logoImg = document.getElementById('companyLogo');
                const fallbackText = document.getElementById('logoTextFallback');
                
                logoImg.src = newLogoUrl;
                logoImg.style.display = 'block';
                fallbackText.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
        // --- FIN FUNCIÓN AGREGADA ---
        
        // CAMBIO: Se eliminan los decimales para los Bolívares.
        function formatBsS(value) {
            return "Bs.S " + new Intl.NumberFormat('es-VE', { style: 'decimal', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
        }

        function formatUSD(value) {
            return "$ " + new Intl.NumberFormat('en-US', { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 4 }).format(value);
        }

        // FUNCIÓN MEJORADA PARA REINTENTO CON BACKOFF EXPONENCIAL
        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) { 
                        // Solo lanza error en el último intento
                        throw error; 
                    }
                    // Retardo de backoff exponencial (1s, 2s, 4s, ...)
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    // No se loggean los reintentos
                }
            }
        }

        async function fetchExchangeRate() {
            // Se usa el valor por defecto fijo de 199.10
            let defaultRate = NEW_DEFAULT_RATE; 
            exchangeRateTextEl.textContent = 'Buscando tasa...';
            exchangeRateTextEl.classList.remove('bg-gray-100', 'text-gray-800', 'bg-red-100', 'text-red-700', 'text-green-700', 'bg-green-100');
            exchangeRateTextEl.classList.add('text-gray-500', 'bg-yellow-100');
            exchangeRateTextEl.setAttribute('contenteditable', 'false');

            // INSTRUCCIÓN REFINADA: Pedir la tasa del BCV del siguiente día hábil
            // OPTIMIZACIÓN: Se hace la instrucción más directa y corta para mejorar velocidad y precisión.
            const systemPrompt = "Actúa como un bot de datos financieros. Proporciona la tasa de cambio USD/Bs.S publicada por el Banco Central de Venezuela (BCV) que será *vigente para el siguiente día hábil*. Responde ÚNICAMENTE con el valor numérico RAW de la tasa, usando un punto como separador decimal, sin texto, comas, ni símbolos. Ejemplo: 36.50";
            const userQuery = "Tasa de cambio USD/Bs.S BCV para mañana";
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                let rateText = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || '';
                
                // Procesamiento robusto
                rateText = rateText.replace(',', '.'); // Reemplazar comas por puntos
                rateText = rateText.replace(/[^\d.]/g, ''); // Remover todo lo que no sea dígito o punto
                
                let newRate = parseFloat(rateText);
                
                // VALIDACIÓN AGRESIVA: Si falla la búsqueda o la tasa es irreal (<= 10), usa el fallback.
                if (isNaN(newRate) || newRate <= 10.00) { 
                    throw new Error(`Tasa no válida recibida o valor demasiado bajo: ${rateText}`); 
                }

                const formattedRate = formatUSD(newRate).replace("$ ", "");
                exchangeRateTextEl.textContent = formattedRate; 
                exchangeRateTextEl.classList.remove('text-gray-500', 'bg-yellow-100', 'bg-red-100', 'text-red-700', 'text-green-700', 'bg-green-100');
                exchangeRateTextEl.classList.add('bg-green-100', 'text-green-700');
                exchangeRateTextEl.title = `Tasa del día (${formattedRate}). Puedes editarla manualmente.`;
                
            } catch (error) {
                console.warn("Fallo la busqueda de la tasa referencial del BCV. Usando tasa manual.", error.message);
                
                // Si falla la búsqueda, el sistema usa el valor cargado o el valor fijo (199.10)
                let currentRateContent = exchangeRateTextEl.textContent.trim().replace(/[^\d.]/g, '');
                let fallbackRate = parseFloat(currentRateContent) || defaultRate;

                exchangeRateTextEl.textContent = formatUSD(fallbackRate).replace("$ ", "");
                exchangeRateTextEl.classList.remove('text-gray-500', 'bg-yellow-100', 'bg-gray-100', 'text-gray-800', 'bg-green-100', 'text-green-700');
                exchangeRateTextEl.classList.add('bg-red-100', 'text-red-700');
                exchangeRateTextEl.title = `ERROR al obtener la tasa. Usando valor actual (${fallbackRate}). Edítalo si es necesario.`;
            } finally {
                exchangeRateTextEl.setAttribute('contenteditable', 'true');
                calculateTotal();
            }
        }
        
        function toggleTermsPrint() {
            // Lógica simplificada: SOLO afecta la línea del IVA
            if (toggleTermsCheckbox.checked) {
                taxLineEl.classList.remove('hidden'); 
                taxRateTextEl.setAttribute('contenteditable', 'true'); 
            } else {
                taxLineEl.classList.add('hidden'); 
                taxRateTextEl.setAttribute('contenteditable', 'false'); 
            }
            calculateTotal(); 
            // REMOVED: No guardar automáticamente al cambiar el checkbox
        }
        
        // FUNCIÓN CLAVE ACTUALIZADA
        function toggleBsSDisplay() {
            const isChecked = toggleBsSCheckbox.checked;
            const bsLines = document.querySelectorAll('.bs-line');
            const exchangeRateLine = document.getElementById('exchangeRateLine');

            if (!isChecked) {
                bsLines.forEach(line => line.classList.add('hidden'));
                if (exchangeRateLine) exchangeRateLine.classList.add('hidden');
                
                bsColHeader.innerHTML = 'TOTAL (<span class="text-xs">$</span>)';
                if (totalUsdLabel) totalUsdLabel.textContent = 'TOTAL:';
            } else {
                bsLines.forEach(line => line.classList.remove('hidden'));
                 if (exchangeRateLine) exchangeRateLine.classList.remove('hidden');

                bsColHeader.textContent = 'TOTAL (Bs.S)';
                if (totalUsdLabel) totalUsdLabel.textContent = 'TOTAL (USD $):';
            }
            
            calculateTotal();
        }
        
        // FUNCIÓN CLAVE: Muestra/Oculta Datos de Pago
        function togglePaymentDetails() {
            const isChecked = document.getElementById('togglePaymentDetails').checked;
            if (isChecked) {
                paymentDetailsSection.classList.remove('hidden');
            } else {
                paymentDetailsSection.classList.add('hidden');
            }
            // REMOVED: No guardar automáticamente al cambiar el checkbox
        }

        function handleDescriptionFocus(event) {
            const span = event.target;
            span.classList.remove('text-gray-400');
            if (span.textContent.trim() === 'Mantenimiento') {
                span.textContent = '';
            }
        }

        // CAMBIO: Lógica mejorada para manejar el efecto fantasma consistentemente.
        function handleDescriptionBlur(event) {
            const span = event.target;
            // Si el campo está vacío, lo rellenamos con el placeholder.
            if (span.textContent.trim() === '') {
                span.textContent = 'Mantenimiento';
            }
            // Si el campo contiene el texto del placeholder, SIEMPRE aplicamos el estilo gris.
            if (span.textContent.trim() === 'Mantenimiento') {
                span.classList.add('text-gray-400');
            }
        }
        
        function setupDescriptionListeners() {
            document.querySelectorAll('.line-item').forEach(row => {
                const descriptionSpan = row.querySelector('.description-text');
                descriptionSpan.addEventListener('focus', handleDescriptionFocus);
                descriptionSpan.addEventListener('blur', handleDescriptionBlur);
                if (descriptionSpan.textContent.trim() !== 'Mantenimiento') {
                     descriptionSpan.classList.remove('text-gray-400');
                } else {
                    descriptionSpan.classList.add('text-gray-400');
                }
            });
        }
        
        function setCurrentDate() {
            const today = new Date();
            const dateOptions = { day: '2-digit', month: '2-digit', year: 'numeric' };
            document.getElementById('currentDate').textContent = today.toLocaleDateString('es-ES', dateOptions);
        }

        function initialLoadSetup(nextId = DEFAULT_BUDGET_ID) {
            setCurrentDate();
            
            // Si el ID actual es el ID por defecto, lo actualizamos con el siguiente de la secuencia.
            if (budgetIdElement.textContent.trim() === DEFAULT_BUDGET_ID) {
                budgetIdElement.textContent = nextId;
            }

            if (lineItemsContainer.children.length === 0) {
                 createLineItemRow();
            }
            
            // Configuración inicial del logo
            if (companyLogo) companyLogo.src = DEFAULT_LOGO_URL;
            if (companyLogo) companyLogo.style.display = 'block';
            if (document.getElementById('logoTextFallback')) document.getElementById('logoTextFallback').style.display = 'none';
            if (document.getElementById('logoSizeRange')) resizeLogo(document.getElementById('logoSizeRange').value);
            
            // Ejecutar lógica del IVA al cargar
            toggleTermsPrint(); 
            togglePaymentDetails(); // Ejecuta la nueva lógica de pago
            toggleBsSDisplay(); // Ejecuta la nueva lógica Bs.S
            calculateTotal();
            setupDescriptionListeners();
            // Ejecutar la actualización inicial del RIF/C.I.
            if (document.getElementById('clientRif')) updateRifLabel(document.getElementById('clientRif').value);
            
            // Asegurar que la tasa se muestre con el valor por defecto si no hay nada en Firebase
            if (exchangeRateTextEl && exchangeRateTextEl.textContent.trim() === 'Cargando...') {
                 exchangeRateTextEl.textContent = formatUSD(NEW_DEFAULT_RATE).replace("$ ", "");
                 exchangeRateTextEl.classList.remove('text-gray-500', 'bg-yellow-100');
                 exchangeRateTextEl.classList.add('bg-gray-100', 'text-gray-800');
                 exchangeRateTextEl.title = 'Tasa del día (valor por defecto). Puedes editarla manualmente.';
            }
        }
        
        function promptRemoveLineItem(buttonElement) {
            if (lineItemsContainer.children.length > 1) {
                itemToRemove = buttonElement.closest('.line-item');
                confirmationModal.classList.remove('hidden');
            } else {
                console.warn("No se puede eliminar la última partida.");
            }
        }

        function confirmRemoval() {
            if (itemToRemove) {
                itemToRemove.remove();
                itemToRemove = null;
                closeModal();
                calculateTotal();
                // REMOVED: No guardar automáticamente al eliminar partida
            }
        }
        
        function closeModal() {
            confirmationModal.classList.add('hidden');
            itemToRemove = null;
        }

        // FUNCIÓN CLAVE ACTUALIZADA
        function calculateTotal() {
            let totalSubtotalBsS = 0;
            let totalSubtotalUSD = 0;

            let taxRateValue = 0;
            if (toggleTermsCheckbox && toggleTermsCheckbox.checked) {
                const rawTaxRate = taxRateTextEl.textContent.trim().replace(',', '.').replace(/[^\d.]/g, '');
                taxRateValue = parseFloat(rawTaxRate) / 100 || TAX_RATE_DEFAULT;
            }

            let rawRate = exchangeRateTextEl.textContent.trim().replace(',', '.').replace(/[^\d.]/g, '');
            let exchangeRateValue = parseFloat(rawRate) || 1.0;
            if (exchangeRateValue <= 0) exchangeRateValue = 1.0;

            const showBsS = toggleBsSCheckbox.checked;

            document.querySelectorAll('.line-item').forEach(row => {
                const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
                const unitPriceUSD = parseFloat(row.querySelector('.unit-price').value) || 0;
                const totalPriceEl = row.querySelector('.total-price');

                const lineTotalUSD = quantity * unitPriceUSD;
                const lineTotalBsS = lineTotalUSD * exchangeRateValue;

                totalSubtotalBsS += lineTotalBsS;
                totalSubtotalUSD += lineTotalUSD;

                if (totalPriceEl) {
                    totalPriceEl.textContent = showBsS ? formatBsS(lineTotalBsS) : formatUSD(lineTotalUSD);
                }
            });

            const taxAmountBsS = totalSubtotalBsS * taxRateValue;
            const taxAmountUSD = totalSubtotalUSD * taxRateValue;
            const totalWithTaxUSD = totalSubtotalUSD + taxAmountUSD;

            // --- INICIO DE LA LÓGICA DE SUBTOTAL MEJORADA ---
            const subtotalLabelEl = document.getElementById('subtotalLabel');
            if (showBsS) {
                if (subtotalLabelEl) subtotalLabelEl.textContent = 'Subtotal (Bs.S):';
                if (subtotalEl) subtotalEl.textContent = formatBsS(totalSubtotalBsS);
                if (subtotalLine) subtotalLine.classList.remove('hidden');
            } else {
                if (subtotalLabelEl) subtotalLabelEl.textContent = 'Subtotal ($):';
                if (subtotalEl) subtotalEl.textContent = formatUSD(totalSubtotalUSD);
                if (subtotalLine) subtotalLine.classList.remove('hidden'); // Asegurarse de que esté visible
            }
            // --- FIN DE LA LÓGICA DE SUBTOTAL MEJORADA ---

            if (taxAmountEl) {
                taxAmountEl.textContent = showBsS ?
                    formatBsS(taxRateValue > 0 ? taxAmountBsS : 0) :
                    formatUSD(taxRateValue > 0 ? taxAmountUSD : 0);
            }
            if (grandTotalBsSEl) grandTotalBsSEl.textContent = formatBsS(totalSubtotalBsS + taxAmountBsS);
            if (grandTotalUSDEl) grandTotalUSDEl.textContent = formatUSD(totalWithTaxUSD);
        }
        
        /**
         * NUEVO: Lógica mejorada para la exportación.
         * Reemplaza inputs con texto estático y limpia los placeholders.
         */
        function replaceInputsForExport() {
            const tempElements = [];
            
            // Maneja todos los inputs de cliente y pago
            document.querySelectorAll('#section-client-info .input-client, #paymentDetailsSection .input-client').forEach(input => {
                const span = document.createElement('span');
                // CAMBIO CLAVE: Si el valor está vacío, el span estará vacío (no se usa el placeholder)
                span.textContent = input.value || '';
                span.className = input.className.replace(/input-client|input-rif-ci|w-2\/3|ml-1/g, ' ');

                input.style.display = 'none';
                input.parentNode.insertBefore(span, input);
                tempElements.push({ original: input, replacement: span });
            });

            // Maneja los inputs numéricos de la tabla
            document.querySelectorAll('.line-item .input-number').forEach(input => {
                 const span = document.createElement('span');
                 span.textContent = input.value;
                 span.className = input.className.replace('input-number', '');
                 input.style.display = 'none';
                 input.parentNode.insertBefore(span, input);
                 tempElements.push({ original: input, replacement: span });
            });
            
            // CAMBIO CLAVE: Maneja las descripciones editables
            document.querySelectorAll('.description-text').forEach(span => {
                if (span.textContent.trim() === 'Mantenimiento') {
                    const originalText = span.textContent;
                    const originalClasses = span.className;
                    span.textContent = ''; // Lo vacía para la exportación
                    span.classList.remove('text-gray-400');

                    // Añade una acción de restauración personalizada
                    tempElements.push({
                        original: span,
                        replacement: null, // No hay elemento de reemplazo
                        restoreAction: (el) => {
                            el.textContent = originalText;
                            el.className = originalClasses;
                        }
                    });
                }
            });

            return tempElements;
        }

        /**
         * NUEVO: Lógica mejorada de restauración.
         * Restaura los inputs y las acciones personalizadas (como los placeholders de descripción).
         */
        function restoreInputsAfterExport(tempElements) {
            tempElements.forEach(({ original, replacement, restoreAction }) => {
                if (restoreAction) {
                    // Ejecuta la acción personalizada si existe
                    restoreAction(original);
                } else if (replacement) {
                    // De lo contrario, realiza la restauración estándar
                    original.style.display = '';
                    if (replacement.parentNode) {
                        replacement.parentNode.removeChild(replacement);
                    }
                }
            });
        }
        
        /**
         * Helper function for the old sharing method (download + text link).
         */
        function fallbackShare(imageUrl, fileName, message) {
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank'); // Abrir en una nueva pestaña para no perder el editor

            showNotification('¡Listo! Se descargó la imagen y se abrió WhatsApp. Solo tienes que adjuntar el archivo.', 'info');
        }

        /**
         * Generates the image and uses the Web Share API to share it directly if available.
         * Falls back to the old download-and-share method if not supported.
         */
        async function shareViaWhatsApp() {
            const container = document.querySelector('.budget-container');
            const noPrintElements = document.querySelectorAll('.budget-container .no-print');
            
            showNotification('Generando imagen en formato PNG (alta calidad) y preparando para compartir...', 'info');
            
            container.classList.add('export-layout');
            noPrintElements.forEach(el => el.style.setProperty('display', 'none', 'important'));
            
            const tempElements = replaceInputsForExport();

            await new Promise(resolve => setTimeout(resolve, 100));

            try {
                const canvas = await html2canvas(container, {
                    backgroundColor: '#ffffff',
                    scale: 3,
                    useCORS: true,
                    allowTaint: true
                });

                const budgetId = document.querySelector('#budgetId').textContent.trim() || 'Presupuesto';
                const clientName = document.getElementById('clientName').value.trim();
                const fileName = `${budgetId.replace(/[\s\/\\:*?"<>|]/g, '_')}.png`;
                const message = `Presupuesto ${budgetId} - ${clientName || 'Cliente'}`;

                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                
                if (!blob) throw new Error("Failed to create image blob.");

                const file = new File([blob], fileName, { type: 'image/png' });
                const shareData = {
                    files: [file],
                    title: `Presupuesto ${budgetId}`,
                    text: message,
                };

                if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                    // Use modern Web Share API
                    await navigator.share(shareData);
                    showNotification('¡Se ha abierto el diálogo para compartir!', 'success');
                } else {
                    // Fallback for older browsers or desktop environments
                    showNotification('Esta función es para móviles. En ordenador, se descargará la imagen y se abrirá WhatsApp.', 'info');
                    await new Promise(resolve => setTimeout(resolve, 1500)); // Pequeña pausa para que el usuario lea
                    fallbackShare(canvas.toDataURL('image/png'), fileName, message);
                }

            } catch (error) {
                if (error.name !== 'AbortError') { // Ignore user cancellation of share dialog
                    console.error("Error al exportar/compartir:", error);
                    showNotification('Error al generar la imagen. Intenta imprimir como PDF (Ctrl+P).', 'error');
                }
            } finally {
                container.classList.remove('export-layout');
                noPrintElements.forEach(el => el.style.removeProperty('display'));
                restoreInputsAfterExport(tempElements);
            }
        }

        /**
         * NUEVO: Genera y descarga una imagen PNG de alta calidad del presupuesto.
         */
        async function exportAsPng() {
            const container = document.querySelector('.budget-container');
            const noPrintElements = document.querySelectorAll('.budget-container .no-print');
            
            showNotification('Generando imagen PNG de alta calidad...', 'info');
            
            container.classList.add('export-layout');
            noPrintElements.forEach(el => el.style.setProperty('display', 'none', 'important'));
            
            const tempElements = replaceInputsForExport();

            await new Promise(resolve => setTimeout(resolve, 100));
            
            try {
                const canvas = await html2canvas(container, {
                    backgroundColor: '#ffffff',
                    scale: 3,
                    useCORS: true,
                    allowTaint: true
                });
                
                const imageUrl = canvas.toDataURL('image/png');
                const budgetId = document.querySelector('#budgetId').textContent.trim() || 'Presupuesto';
                const fileName = `${budgetId.replace(/[\s\/\\:*?"<>|]/g, '_')}.png`;

                // Crear y simular clic en un enlace de descarga
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showNotification('¡Imagen PNG descargada exitosamente!', 'success');

            } catch (error) {
                console.error("Error al exportar a PNG:", error);
                showNotification('Error al generar la imagen PNG. Intenta de nuevo.', 'error');
            } finally {
                // Restaurar estado original
                container.classList.remove('export-layout');
                noPrintElements.forEach(el => el.style.removeProperty('display'));
                restoreInputsAfterExport(tempElements);
            }
        }

        /**
         * Llama a la ventana de impresión del navegador para generar un PDF.
         */
        async function exportPdf() {
            // Asegúrate de que todos los totales estén actualizados
            calculateTotal(); 
            
            showNotification('Generando PDF en formato A4, por favor espera...', 'info');
            
            const container = document.querySelector('.budget-container');
            const noPrintElements = document.querySelectorAll('.budget-container .no-print');
            
            container.classList.add('export-layout');
            noPrintElements.forEach(el => el.style.setProperty('display', 'none', 'important'));
            
            const tempElements = replaceInputsForExport();

            await new Promise(resolve => setTimeout(resolve, 100)); // Pequeña pausa para renderizado

            try {
                // 2. Capturar la imagen con html2canvas
                const canvas = await html2canvas(container, {
                    backgroundColor: '#ffffff',
                    scale: 3, // Usar un scale alto para mejor calidad (300 DPI aprox)
                    useCORS: true,
                    allowTaint: true
                });

                const imgData = canvas.toDataURL('image/png');
                
                // 3. Crear el PDF con jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4'); // p = portrait, mm = milímetros, a4 = formato A4
                
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                // Agrega la imagen al PDF, ajustada al ancho y alto de la página A4
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

                // 4. Descargar el archivo PDF
                const budgetId = document.querySelector('#budgetId').textContent.trim() || 'Presupuesto';
                const fileName = `${budgetId.replace(/[\s\/\\:*?"<>|]/g, '_')}_${Date.now()}.pdf`;
                pdf.save(fileName);
                
                showNotification('PDF descargado. ¡Ya puedes compartirlo!', 'success');

            } catch (error) {
                console.error("Error al exportar a PDF:", error);
                showNotification('Error al generar el PDF. Revisa la consola para más detalles.', 'error');
            } finally {
                container.classList.remove('export-layout');
                noPrintElements.forEach(el => el.style.removeProperty('display'));
                restoreInputsAfterExport(tempElements);
            }
        }
        
        // --- INICIO: NUEVA FUNCIÓN PARA EXPORTAR COMO HTML FUNCIONAL ---
        function exportAsFunctionalHTML() {
            showNotification('Preparando la exportación web...', 'info');

            // 1. Clonar el documento para no modificar la página actual
            const clonedDocument = document.documentElement.cloneNode(true);

            // 2. Guardar los valores actuales de los inputs en el clon
            const originalInputs = document.querySelectorAll('input, textarea');
            const clonedInputs = clonedDocument.querySelectorAll('input, textarea');
            originalInputs.forEach((input, index) => {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    if (input.checked) {
                        clonedInputs[index].setAttribute('checked', '');
                    } else {
                        clonedInputs[index].removeAttribute('checked');
                    }
                } else {
                    clonedInputs[index].setAttribute('value', input.value);
                }
            });

            // 3. Guardar el contenido de los elementos editables
            const originalEditables = document.querySelectorAll('[contenteditable="true"]');
            const clonedEditables = clonedDocument.querySelectorAll('[contenteditable="true"]');
            originalEditables.forEach((el, index) => {
                clonedEditables[index].innerHTML = el.innerHTML;
            });

            // 4. Crear el contenido del archivo HTML
            const htmlContent = clonedDocument.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);

            // 5. Crear y simular el clic en el enlace de descarga
            const a = document.createElement('a');
            a.href = url;
            a.download = 'presupuesto.html';
            document.body.appendChild(a);
            a.click();
            
            // 6. Limpieza
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Página web exportada exitosamente.', 'success');
        }
        // --- FIN: NUEVA FUNCIÓN PARA EXPORTAR ---

        function exportBudgetDataAsJson() {
            try {
                const data = collectBudgetData();
                const jsonString = JSON.stringify(data, null, 2); 
                const blob = new Blob([jsonString], { type: 'application/json' });
                
                const a = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                const budgetId = document.querySelector('#budgetId').textContent.trim() || 'Presupuesto';
                a.href = url;
                a.download = `presupuesto_data_${budgetId.replace(/[\s\/\\:*?"<>|]/g, '_')}_${Date.now()}.json`;
                
                document.body.appendChild(a);
                a.click();
                
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log("Datos exportados como JSON.");
            } catch (error) {
                console.error("Error al exportar los datos JSON:", error);
            }
        }

        function showNotification(message, type = 'info') {
            let bgColor, textColor;
            if (type === 'success') {
                bgColor = 'bg-green-500';
                textColor = 'text-white';
            } else if (type === 'error') {
                bgColor = 'bg-red-500';
                textColor = 'text-white';
            } else { // info
                bgColor = 'bg-blue-100';
                textColor = 'text-blue-700';
            }

            notificationMessageEl.textContent = message;
            notificationMessageEl.className = `no-print fixed top-10 left-1/2 transform -translate-x-1/2 z-1000 p-3 rounded-lg shadow-2xl font-semibold ${bgColor} ${textColor}`;
            notificationMessageEl.classList.remove('hidden');

            if (type !== 'error') {
                 setTimeout(() => {
                    notificationMessageEl.classList.add('hidden');
                }, 7000); // Aumento el tiempo para que el usuario lea la instrucción clave
            }
        }
        
        // --- AUTENTICACIÓN Y CARGA INICIAL ---
        async function setupAuthAndLoad() {
            // MOVIDO: Inicialización de la aplicación y servicios dentro de setupAuthAndLoad
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const app = window.firebase.initializeApp(firebaseConfig);
            db = window.firebase.getFirestore(app);
            auth = window.firebase.getAuth(app);
            
            const saveStatusEl = document.getElementById('saveStatus');
            saveStatusEl.classList.remove('hidden');
            saveStatusEl.textContent = 'Inicializando...';
            
            try {
                 if (typeof __initial_auth_token !== 'undefined') { 
                    // CORRECCIÓN CLAVE: Llamar a la función importada y pasarle la instancia 'auth'
                    await window.firebase.signInWithCustomToken(auth, __initial_auth_token); 
                } else { 
                    // CORRECCIÓN CLAVE: Llamar a la función importada y pasarle la instancia 'auth'
                    await window.firebase.signInAnonymously(auth); 
                }

                userId = auth.currentUser?.uid || crypto.randomUUID();
                
                // Asegurarse de que el userId esté disponible antes de cargar
                if (userId) {
                    loadBudget();
                    fetchExchangeRate();
                } else {
                    throw new Error("No se pudo obtener el ID de usuario.");
                }

            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                saveStatusEl.textContent = 'Error de conexión';
                saveStatusEl.classList.add('bg-red-200', 'text-red-700');
            }
        }
        
        window.onload = setupAuthAndLoad;

        // --- FUNCIONES ADICIONALES (RIF, ITEM, ETC) ---

        function updateRifLabel(value) {
            const rifLabel = document.getElementById('rifLabel');
            const firstChar = value.trim().toUpperCase()[0];
            
            if (['J', 'G', 'C', 'P', 'S'].includes(firstChar)) {
                rifLabel.textContent = 'RIF:';
            } else if (['V', 'E', 'P'].includes(firstChar)) {
                rifLabel.textContent = 'C.I.:';
            } else {
                rifLabel.textContent = 'RIF/C.I.:';
            }
        }
        
        // --- INICIO: NUEVA LÓGICA PARA CREAR PARTIDAS ---

        // Función auxiliar que solo devuelve el HTML de una fila
        function createLineItemRowHTML(item = { description: 'Mantenimiento', quantity: 1, unit_price: 0 }) {
            return `
                <td class="p-2 sm:p-3 relative group">
                    <span contenteditable="true" class="description-text block w-full pr-20 py-1">${item.description}</span>
                    <div class="action-buttons absolute top-1/2 -translate-y-1/2 right-2 opacity-0 group-focus-within:opacity-100 group-hover:opacity-100 flex items-center space-x-1 transition-opacity duration-200">
                         <button onclick="addLineItemAfter(this)" title="Añadir partida debajo" class="add-item-fab">
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                         </button>
                         <button onclick="promptRemoveLineItem(this)" title="Eliminar partida" class="delete-btn-fab">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
                         </button>
                    </div>
                </td>
                <td class="p-2 sm:p-3 text-right min-w-[120px]">
                    <input type="text" value="${item.quantity}" min="0" class="input-number quantity font-data whitespace-nowrap" oninput="calculateTotal();" onkeypress="return isNumberKey(event)">
                </td>
                <td class="p-2 sm:p-3 text-right min-w-[170px]">
                    <input type="text" value="${item.unit_price}" min="0" step="0.01" class="input-number unit-price text-green-600 font-medium font-data whitespace-nowrap" oninput="calculateTotal();" onkeypress="return isNumberKey(event)">
                </td>
                <td class="p-2 sm:p-3 text-right min-w-[160px] bs-col-data">
                    <span class="total-price font-semibold font-data whitespace-nowrap">Bs.S 0,00</span>
                </td>
            `;
        }

        // Función que crea y AÑADE una fila al final (usada al cargar/limpiar)
        function createLineItemRow(item = { description: 'Mantenimiento', quantity: 1, unit_price: 0 }) {
            const newRow = document.createElement('tr');
            newRow.className = 'line-item border-b border-gray-200 text-sm';
            newRow.innerHTML = createLineItemRowHTML(item);
            
            lineItemsContainer.appendChild(newRow);
            
            const descriptionSpan = newRow.querySelector('.description-text');
            descriptionSpan.addEventListener('input', calculateTotal);
            descriptionSpan.addEventListener('focus', handleDescriptionFocus);
            descriptionSpan.addEventListener('blur', handleDescriptionBlur);
            handleDescriptionBlur({ target: descriptionSpan });
        }

        // NUEVA FUNCIÓN: Se activa desde el botón "+" en la fila
        function addLineItemAfter(buttonElement) {
            const currentRow = buttonElement.closest('.line-item');
            if (currentRow) {
                const newRow = document.createElement('tr');
                newRow.className = 'line-item border-b border-gray-200 text-sm';
                newRow.innerHTML = createLineItemRowHTML(); // Crea una fila por defecto
                
                currentRow.parentNode.insertBefore(newRow, currentRow.nextSibling);

                const descriptionSpan = newRow.querySelector('.description-text');
                descriptionSpan.addEventListener('input', calculateTotal);
                descriptionSpan.addEventListener('focus', handleDescriptionFocus);
                descriptionSpan.addEventListener('blur', handleDescriptionBlur);
                handleDescriptionBlur({ target: descriptionSpan });
                
                descriptionSpan.focus();
            }
        }
        // --- FIN: NUEVA LÓGICA PARA CREAR PARTIDAS ---


        function isNumberKey(evt) {
            const charCode = (evt.which) ? evt.which : evt.keyCode;
            const target = evt.target;
            
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                if (charCode === 46) {
                    if (target.value.indexOf('.') !== -1) {
                        return false;
                    }
                } else {
                    return false;
                }
            }
            return true;
        }

        // --- FUNCIONES DE FORMATO AUTOMÁTICO ---
        function formatPhoneNumber(input) {
            // Elimina caracteres no numéricos para limpiar la entrada
            let digits = input.value.replace(/[^\d]/g, '');
            // Si hay más de 4 dígitos, inserta un guion
            if (digits.length > 4) {
                input.value = digits.slice(0, 4) + '-' + digits.slice(4, 11); // Formato 0412-1234567
            } else {
                input.value = digits;
            }
        }

        function formatContactField(input) {
            let value = input.value;
            // Solo formatea si la entrada parece un número de teléfono (empieza con un dígito)
            if (/^\d/.test(value)) {
                formatPhoneNumber(input); // Reutiliza la misma lógica de formato
            }
            // Si no, permite que el usuario escriba un nombre sin modificarlo.
        }

        function formatRif(input) {
            let value = input.value.toUpperCase().replace(/[^A-Z0.9]/g, ''); // Limpia la entrada
            // Si el primer caracter es una letra válida y hay más de un caracter, inserta el guion
            if (value.length > 1 && /[JVGCEP]/.test(value[0])) {
                input.value = (value[0] + '-' + value.substring(1)).slice(0, 12);
            } else {
                input.value = value.slice(0, 12); // Si no, solo muestra el valor limpio
            }
        }

        // --- END FUNCIONES ADICIONALES ---

    </script>
</body>
</html>

